<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ZCCçš„åšå®¢</title>
  
  <subtitle>å¤©é“é…¬å‹¤</subtitle>
  <link href="https://blog.zcchub.xyz/atom.xml" rel="self"/>
  
  <link href="https://blog.zcchub.xyz/"/>
  <updated>2022-04-02T19:22:09.115Z</updated>
  <id>https://blog.zcchub.xyz/</id>
  
  <author>
    <name>Zcc</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>1 æ ¸ 1G çš„ VPS èƒ½ç©å‡ºä»€ä¹ˆèŠ±æ ·</title>
    <link href="https://blog.zcchub.xyz/vps/selfhosted/"/>
    <id>https://blog.zcchub.xyz/vps/selfhosted/</id>
    <published>2022-03-27T06:25:47.000Z</published>
    <updated>2022-04-02T19:22:09.115Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€å¼€å§‹ç¬¬ä¸€å°é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼Œåœ¨ä¸Šé¢è·‘æœåŠ¡éƒ½æ˜¯çº¯æ‰‹å·¥ç¼–è¯‘æ‰“åŒ…ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç„¶åå†ç”¨ <code>nohup</code>, <code>systemd</code> ä¹‹ç±»çš„å·¥å…·æŒ‚åœ¨åå°ã€‚åæ¥å­¦äº† Dockerï¼Œå†åæ¥ç”¨ä¸€äº› Docker çš„å›¾å½¢ç•Œé¢ï¼ˆportainerï¼‰çœå»äº† <code>ssh</code> è¿›æœåŠ¡å™¨æ•²å‘½ä»¤çš„è¿‡ç¨‹ã€‚ä½†æ˜¯é…ç½®åŸŸåï¼Œä¾ç„¶éœ€è¦æŠ˜è…¾ nginx æˆ–è€… Caddyï¼Œå¦‚æœæ˜¯å¢ƒå†…æœåŠ¡å™¨è¿˜éœ€è¦èµ°éº»çƒ¦çš„å¤‡æ¡ˆæµç¨‹ã€‚æ‰€ä»¥ï¼Œæœ€è¿‘å°è¯•äº†å‡ ä¸ª PaaS æ–¹æ¡ˆï¼Œå®ƒä»¬é€šå¸¸èƒ½è‡ªåŠ¨åŒ–ç¼–è¯‘ã€éƒ¨ç½²ã€é…ç½®åŸŸååå‘ä»£ç†ã€SSL è¯ä¹¦è‡ªåŠ¨ç»­æœŸ ...</p><span id="more"></span><h2 id="å…å¤‡æ¡ˆ"><a href="#å…å¤‡æ¡ˆ" class="headerlink" title="å…å¤‡æ¡ˆ"></a>å…å¤‡æ¡ˆ</h2><p>æ²¡æœ‰ä»€ä¹ˆæ­ªé—¨é‚ªé“ï¼Œå¦‚æœå«Œå¤‡æ¡ˆéº»çƒ¦ï¼Œå°±è€è€å®å®å¤šèŠ±ä¸€ç‚¹é’±ä¹°ä¸ªé¦™æ¸¯çš„æœºå­ï¼ˆæˆ–è€…æ–°åŠ å¡ï¼Œæ—¥æœ¬ï¼Œæ´›æ‰çŸ¶ ...ï¼‰ï¼Œè·‘ä¸€äº›ä¸ªäººå°é¡¹ç›®è¶³çŸ£ã€‚å®ƒä»¬ä¸ä»…å…å¤‡æ¡ˆï¼Œ<strong>è€Œä¸”</strong>åœ¨ä½¿ç”¨å¤§éƒ¨åˆ†åŒ…ç®¡ç†å·¥å…·çš„æ—¶å€™éƒ½å¯ä»¥ç›´æ¥ç”¨é»˜è®¤çš„æºï¼ŒğŸ‘ é€Ÿåº¦è¶…èµ</p><h2 id="CapRover"><a href="#CapRover" class="headerlink" title="CapRover"></a>CapRover</h2><p><span class="exturl" data-url="aHR0cHM6Ly9jYXByb3Zlci5jb20v">CapRover<i class="fa fa-external-link-alt"></i></span> æ˜¯ Heroku çš„ self-hosted æ›¿ä»£æ–¹æ¡ˆï¼Œå®ƒå®Œå…¨å¼€æºï¼Œæ¯æœˆ 5$ çš„ 1C1G æœºå­å°±å¯ä»¥è¿è¡Œ</p><h3 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h3><p>å…¶å® <span class="exturl" data-url="aHR0cHM6Ly9kb2trdS5jb20v">Dokku<i class="fa fa-external-link-alt"></i></span> ä¹ŸæŒºä¸é”™ï¼Œåªæ˜¯æˆ‘æ›´å–œæ¬¢åœ¨ Web ç•Œé¢ä¸Šæ“ä½œï¼Œ<code>Dockerfile</code> ä¹Ÿèƒ½æ»¡è¶³å¤§éƒ¨åˆ†åº”ç”¨çš„éœ€æ±‚ã€‚æœ€é‡è¦çš„æ˜¯ CapRover æœ‰ä¸€ä¸ªå« <strong>One Click Apps</strong> çš„åŠŸèƒ½ï¼Œèƒ½ä¸€é”®éƒ¨ç½² Gitea, Gitlab, Drone, Wordpress, Ghost ç­‰å¸¸è§åº”ç”¨ï¼ŒğŸ˜… æœ‰ç‚¹åƒå®å¡”ï¼Œæœ‰ä¸€è¯´ä¸€è¿˜æŒºé¦™</p><table><thead><tr><th align="center">CapRover</th><th align="center">Dokku</th><th align="center">Heroku</th></tr></thead><tbody><tr><td align="center">ä¾¿å®œ</td><td align="center">ä¾¿å®œ</td><td align="center">è´µ</td></tr><tr><td align="center">åªæ”¯æŒ Dockerfile æˆ– docker-compose</td><td align="center">å„ç§ buildpacks</td><td align="center">å„ç§ buildpacks</td></tr><tr><td align="center">æœ‰ Web ç•Œé¢</td><td align="center">ShellScript</td><td align="center">æœ‰ Web ç•Œé¢</td></tr><tr><td align="center">åŸºäº Docker Swarm</td><td align="center">åŸºäº Docker</td><td align="center">-</td></tr></tbody></table><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>ç…§ç€å®˜ç½‘çš„ <span class="exturl" data-url="aHR0cHM6Ly9jYXByb3Zlci5jb20vZG9jcy9nZXQtc3RhcnRlZC5odG1s">Getting Started<i class="fa fa-external-link-alt"></i></span> æ…¢æ…¢åšå°±è¡Œï¼Œæ³¨æ„å¾—æå‰å®‰è£…å¥½ Dockerï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com | sh</span><br></pre></td></tr></table></figure><h2 id="Apps"><a href="#Apps" class="headerlink" title="Apps"></a>Apps</h2><p>æˆ‘ç°åœ¨éƒ¨ç½²çš„ä¸€äº› Appï¼š</p><p><img data-src="https://cdn.jsdelivr.net/gh/MaoLongLong/images/202203271825038.png" loading="lazy"></p><h3 id="go-import-redirector"><a href="#go-import-redirector" class="headerlink" title="go-import-redirector"></a>go-import-redirector</h3><p>Golang å¯¼åŒ…çš„é‡å®šå‘å™¨ï¼Œåœ¨<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3JzYy9nby1pbXBvcnQtcmVkaXJlY3Rvcg==">å¼€æº<i class="fa fa-external-link-alt"></i></span>çš„åŸºç¡€ä¸Šåšäº†ç‚¹æ”¹é€ </p><p>èƒ½æŠŠ <code>go get</code> ä»è‡ªå®šä¹‰åŸŸåé‡å®šå‘åˆ° GitHubï¼š</p><p><img data-src="https://cdn.jsdelivr.net/gh/MaoLongLong/images/202203271833111.png" loading="lazy"></p><p>æˆ–è€…æµè§ˆå™¨ç›´æ¥æ‰“å¼€ï¼Œè·³è½¬åˆ° GoDocï¼š</p><p><img data-src="https://cdn.jsdelivr.net/gh/MaoLongLong/images/202203271830848.png" loading="lazy"></p><h3 id="tinyurl"><a href="#tinyurl" class="headerlink" title="tinyurl"></a>tinyurl</h3><p>è‡ªå·±å†™çš„çŸ­é“¾æ¥å·¥å…·ï¼Œæ²¡å•¥é«˜çº§åŠŸèƒ½ï¼Œ<strong>èƒ½è·‘å°±è¡Œ</strong></p><p><span class="exturl" data-url="aHR0cHM6Ly90LmNoZW5zbC5tZS9sYzEwMTY=">t.chensl.me&#x2F;lc1016<i class="fa fa-external-link-alt"></i></span></p><h3 id="Portainer"><a href="#Portainer" class="headerlink" title="Portainer"></a>Portainer</h3><p>Docker çš„ Web ç•Œé¢ï¼Œç»“åˆç€ CapRover ç”¨æ¥ç®¡ç†å®¹å™¨</p><p><img data-src="https://cdn.jsdelivr.net/gh/MaoLongLong/images/202203271855823.png" loading="lazy"></p><h3 id="Syncthing"><a href="#Syncthing" class="headerlink" title="Syncthing"></a>Syncthing</h3><p>ä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„æ–‡ä»¶åŒæ­¥å·¥å…·ï¼Œç»å¸¸éœ€è¦ç”¨å®ƒå’Œå®¤å‹äº’ä¼ ä¸€äº›æ–‡ä»¶ï¼ˆğŸ˜ˆ ä¸å¯å‘Šäººçš„æ–‡ä»¶ï¼‰</p><h3 id="FileBrowser"><a href="#FileBrowser" class="headerlink" title="FileBrowser"></a>FileBrowser</h3><p>ç»“åˆ Syncthing ä½¿ç”¨ï¼Œåœ¨æ²¡æœ‰å®‰è£… Syncthing çš„ç”µè„‘ä¸Šä¹Ÿèƒ½åœ¨çº¿ç®¡ç†æ–‡ä»¶</p><p><img data-src="https://cdn.jsdelivr.net/gh/MaoLongLong/images/202203271901985.png" loading="lazy"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€å¼€å§‹ç¬¬ä¸€å°é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼Œåœ¨ä¸Šé¢è·‘æœåŠ¡éƒ½æ˜¯çº¯æ‰‹å·¥ç¼–è¯‘æ‰“åŒ…ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç„¶åå†ç”¨ &lt;code&gt;nohup&lt;/code&gt;, &lt;code&gt;systemd&lt;/code&gt; ä¹‹ç±»çš„å·¥å…·æŒ‚åœ¨åå°ã€‚åæ¥å­¦äº† Dockerï¼Œå†åæ¥ç”¨ä¸€äº› Docker çš„å›¾å½¢ç•Œé¢ï¼ˆportainerï¼‰çœå»äº† &lt;code&gt;ssh&lt;/code&gt; è¿›æœåŠ¡å™¨æ•²å‘½ä»¤çš„è¿‡ç¨‹ã€‚ä½†æ˜¯é…ç½®åŸŸåï¼Œä¾ç„¶éœ€è¦æŠ˜è…¾ nginx æˆ–è€… Caddyï¼Œå¦‚æœæ˜¯å¢ƒå†…æœåŠ¡å™¨è¿˜éœ€è¦èµ°éº»çƒ¦çš„å¤‡æ¡ˆæµç¨‹ã€‚æ‰€ä»¥ï¼Œæœ€è¿‘å°è¯•äº†å‡ ä¸ª PaaS æ–¹æ¡ˆï¼Œå®ƒä»¬é€šå¸¸èƒ½è‡ªåŠ¨åŒ–ç¼–è¯‘ã€éƒ¨ç½²ã€é…ç½®åŸŸååå‘ä»£ç†ã€SSL è¯ä¹¦è‡ªåŠ¨ç»­æœŸ ...&lt;/p&gt;</summary>
    
    
    
    <category term="VPS" scheme="https://blog.zcchub.xyz/categories/VPS/"/>
    
    
    <category term="Vultr" scheme="https://blog.zcchub.xyz/tags/Vultr/"/>
    
    <category term="PaaS" scheme="https://blog.zcchub.xyz/tags/PaaS/"/>
    
    <category term="Heroku" scheme="https://blog.zcchub.xyz/tags/Heroku/"/>
    
    <category term="Dokku" scheme="https://blog.zcchub.xyz/tags/Dokku/"/>
    
    <category term="self-hosted" scheme="https://blog.zcchub.xyz/tags/self-hosted/"/>
    
    <category term="CapRover" scheme="https://blog.zcchub.xyz/tags/CapRover/"/>
    
  </entry>
  
  <entry>
    <title>å †å æ–‡ä»¶ç³»ç»Ÿ OverlayFS</title>
    <link href="https://blog.zcchub.xyz/cloud/overlayfs/"/>
    <id>https://blog.zcchub.xyz/cloud/overlayfs/</id>
    <published>2021-10-24T05:12:42.000Z</published>
    <updated>2022-04-02T19:22:09.111Z</updated>
    
    <content type="html"><![CDATA[<p>ç¬¬ä¸€æ¬¡çŸ¥é“è¿™ä¸ªæ¦‚å¿µï¼Œæ˜¯ä½¿ç”¨ Docker æ—¶ï¼Œå®ƒé»˜è®¤ä½¿ç”¨çš„ Graph Driver æ˜¯ Overlay2ï¼Œå®¹å™¨çš„ rootfs å°±æ˜¯ç›´æ¥ä»¥ç›®å½•çš„å½¢å¼åœ¨å®¿ä¸»æœºä¸Šç»„ç»‡ã€‚</p><span id="more"></span><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE1NzcwMzMxL2FydGljbGUvZGV0YWlscy85NjY5OTM4Ng==">æ·±å…¥ç†è§£ overlayfs<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cua2VybmVsLm9yZy9kb2MvaHRtbC9sYXRlc3QvZmlsZXN5c3RlbXMvb3ZlcmxheWZzLmh0bWw=">Linux Kernel documentation<i class="fa fa-external-link-alt"></i></span></li></ul><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><ul><li>VirtualBox</li><li>Vagrant</li></ul><p>ç”¨ vagrant è·‘ä¸€ä¸ªå¸¦æœ‰ docker çš„è™šæ‹Ÿæœºï¼š</p><figure class="highlight rb"><figcaption><span>Vagrantfile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- mode: ruby -*-</span></span><br><span class="line"><span class="comment"># vi: set ft=ruby :</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$script</span> = <span class="string">&lt;&lt;-&#x27;SCRIPT&#x27;</span></span><br><span class="line"><span class="string">sudo tee /etc/apt/sources.list &lt;&lt;-&#x27;EOF&#x27;</span></span><br><span class="line"><span class="string">deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">sudo apt-get -y update</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span></span><br><span class="line"><span class="string">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span></span><br><span class="line"><span class="string">sudo add-apt-repository &quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</span></span><br><span class="line"><span class="string">sudo apt-get -y update</span></span><br><span class="line"><span class="string">sudo apt-get -y install docker-ce</span></span><br><span class="line"><span class="string">sudo mkdir -p /etc/docker</span></span><br><span class="line"><span class="string">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn/&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">sudo systemctl daemon-reload</span></span><br><span class="line"><span class="string">sudo systemctl restart docker</span></span><br><span class="line"><span class="string">sudo systemctl enable docker</span></span><br><span class="line"><span class="string"># Make sure we can actually use docker as the vagrant user</span></span><br><span class="line"><span class="string">sudo usermod -aG docker vagrant</span></span><br><span class="line"><span class="string">sudo docker --version</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">sudo apt-get -y install bash-completion tree</span></span><br><span class="line"><span class="string">SCRIPT</span></span><br><span class="line"></span><br><span class="line">Vagrant.configure(<span class="string">&quot;2&quot;</span>) <span class="keyword">do</span> |<span class="params">config</span>|</span><br><span class="line">  config.vm.box = <span class="string">&quot;bento/ubuntu-18.04&quot;</span></span><br><span class="line">  config.vm.synced_folder <span class="string">&quot;.&quot;</span>, <span class="string">&quot;/vagrant&quot;</span>, <span class="symbol">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  config.vm.provision <span class="string">&quot;shell&quot;</span>, <span class="symbol">inline:</span> <span class="variable">$script</span>, <span class="symbol">privileged:</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="åˆæ­¥è®¤è¯†"><a href="#åˆæ­¥è®¤è¯†" class="headerlink" title="åˆæ­¥è®¤è¯†"></a>åˆæ­¥è®¤è¯†</h2><p>éšä¾¿æ‹‰ä¸€ä¸ªé•œåƒï¼š</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">vagrant@vagrant:~$ docker pull alpine</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/alpine</span><br><span class="line">a0d0a0d46f8b: Pull complete</span><br><span class="line">Digest: sha256:e1c082e3d3c45cccac829840a25941e679c25d438cc8412c2fa221cf1a824e6a</span><br><span class="line">Status: Downloaded newer image for alpine:latest</span><br><span class="line">docker.io/library/alpine:latest</span><br></pre></td></tr></table></figure><p>è¿™æ—¶ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨ç£ç›˜ä¸Šæ‰¾åˆ°å¯¹åº”çš„ç›®å½•ç»“æ„ï¼š</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">vagrant@vagrant:~$ sudo su</span><br><span class="line"></span><br><span class="line">root@vagrant:/home/vagrant# cd /var/lib/docker/overlay2/</span><br><span class="line"></span><br><span class="line">root@vagrant:/var/lib/docker/overlay2# ls</span><br><span class="line">ae64cdecc41d55f445ce1bed819dd312459bc7f2a2ddc80df60c789a5e3b06dc  l</span><br><span class="line"></span><br><span class="line">root@vagrant:/var/lib/docker/overlay2# ls ae64cdecc41d55f445ce1bed819dd312459bc7f2a2ddc80df60c789a5e3b06dc/diff/</span><br><span class="line">bin  dev  etc  home  lib  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br></pre></td></tr></table></figure><p>å†å¼€ä¸€ä¸ªçª—å£ï¼Œå¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼š</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">vagrant@vagrant:~$ docker run --rm -it alpine sh</span><br><span class="line">/ # ls</span><br><span class="line">bin    etc    lib    mnt    proc   run    srv    tmp    var</span><br><span class="line">dev    home   media  opt    root   sbin   sys    usr</span><br></pre></td></tr></table></figure><p>å®¿ä¸»æœºä¸Šçš„ overlay2 ç›®å½•å¤šå‡ºäº†ä¸€äº›ä¸œè¥¿ï¼š</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">root@vagrant:/var/lib/docker/overlay2# ls</span><br><span class="line">7fca31029adbb299211e702a704981f8dcf7a437d6522b565de0b11c353c78e6       ae64cdecc41d55f445ce1bed819dd312459bc7f2a2ddc80df60c789a5e3b06dc</span><br><span class="line">7fca31029adbb299211e702a704981f8dcf7a437d6522b565de0b11c353c78e6-init  l</span><br><span class="line"></span><br><span class="line">root@vagrant:/var/lib/docker/overlay2# mount | grep overlay</span><br><span class="line">overlay on /var/lib/docker/overlay2/7fca31029adbb299211e702a704981f8dcf7a437d6522b565de0b11c353c78e6/merged type overlay (rw,relatime,lowerdir=/var/lib/docker/overlay2/l/6ND2PL2RECUKJ3KFZYGPYCA564:/var/lib/docker/overlay2/l/FDPTXFIRIH3NAJ6N5KIKDUMC6O,upperdir=/var/lib/docker/overlay2/7fca31029adbb299211e702a704981f8dcf7a437d6522b565de0b11c353c78e6/diff,workdir=/var/lib/docker/overlay2/7fca31029adbb299211e702a704981f8dcf7a437d6522b565de0b11c353c78e6/work)</span><br><span class="line"></span><br><span class="line">root@vagrant:/var/lib/docker/overlay2# ls 7fca31029adbb299211e702a704981f8dcf7a437d6522b565de0b11c353c78e6/merged/</span><br><span class="line">bin  dev  etc  home  lib  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªåä¸º <code>overlay</code> çš„é©±åŠ¨æŒ‚è½½åˆ°äº† <code>/var/lib/docker/overlay2/7fca3.../merged</code>ï¼Œä»æŒ‚è½½ä¿¡æ¯å¯ä»¥çœ‹å‡º merged ç›®å½•æ˜¯ç”±å¤šä¸ªç›®å½•è”åˆæŒ‚è½½è€Œæˆï¼Œlowerdir ä¸ºåªè¯»å±‚ (ro)ï¼Œupperdir ä¸ºå¯è¯»å¯å†™å±‚ (rw)ï¼Œå½“éœ€è¦ä¿®æ”¹ lowerdir ä¸­çš„æ–‡ä»¶æ—¶ï¼Œfs ä¼šé‡‡ç”¨<strong>å†™æ—¶å¤åˆ¶</strong>çš„ç­–ç•¥ï¼Œå°†æ–‡ä»¶ä» lowerdir å¤åˆ¶åˆ° upperdir è¿›è¡Œä¿®æ”¹ã€‚åœ¨ merged ç›®å½•ä¸­ï¼ˆæˆ–è€…è¯´åœ¨ docker å®¹å™¨ä¸­ï¼‰æ˜¯æ„ŸçŸ¥ä¸åˆ°è¿™äº›å¤æ‚é€»è¾‘çš„ï¼Œå’Œæ“ä½œæ­£å¸¸ç›®å½•æ²¡æœ‰åŒºåˆ«</p><p><img data-src="https://cdn.jsdelivr.net/gh/MaoLongLong/images/202111161306717.jpeg" loading="lazy"></p><h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><p>å¤§æ¦‚äº†è§£äº† OverlayFS ä¹‹åï¼Œæˆ‘ä»¬æŠ›å¼€ Docker ä»…ä»…ç”¨ Linux å‘½ä»¤è¡Œå°±èƒ½æ¨¡æ‹Ÿå‡ºä¸€ä¸ªç®€å•çš„å®¹å™¨ï¼ˆæ³¨æ„åªæ˜¯ç®€å•æ¨¡æ‹Ÿï¼Œå‡ ä¹è°ˆä¸ä¸Šä»€ä¹ˆéš”ç¦»æ€§ï¼‰</p><p>åœ¨å¼€å§‹å‰å¯ä»¥åˆ‡æ¢åˆ° rootï¼Œå…å¾—ä¸å¿…è¦çš„éº»çƒ¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo su</span><br></pre></td></tr></table></figure><h3 id="åˆ¶ä½œåŸºç¡€-rootfs"><a href="#åˆ¶ä½œåŸºç¡€-rootfs" class="headerlink" title="åˆ¶ä½œåŸºç¡€ rootfs"></a>åˆ¶ä½œåŸºç¡€ rootfs</h3><p>æœ€ååˆ©ç”¨ä¸€ä¸‹ Dockerï¼Œå¯¼å‡ºä¸€ä¸ª alpine çš„ rootfsï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> rootfs &amp;&amp; docker <span class="built_in">export</span> $(docker create alpine) | tar -C rootfs -xvf -</span><br></pre></td></tr></table></figure><h3 id="Lowerdirs"><a href="#Lowerdirs" class="headerlink" title="Lowerdirs"></a>Lowerdirs</h3><p>ç”±äº lowerdir å¯ä»¥é…ç½®å¤šä¸ªï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‰¹æ€§å¯¹ rootfs è¿›è¡Œä¸€äº›å®šåˆ¶ã€‚</p><p>æ›¿æ¢ä¸­ç§‘å¤§æºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p rootfs-init/etc/apk</span><br><span class="line"><span class="built_in">cp</span> rootfs/etc/apk/repositories rootfs-init/etc/apk/</span><br><span class="line">sed -i <span class="string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&#x27;</span> rootfs-init/etc/apk/repositories</span><br></pre></td></tr></table></figure><p>é…ç½® DNSï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;nameserver 223.5.5.5&#x27;</span> &gt; rootfs-init/etc/resolv.conf</span><br></pre></td></tr></table></figure><h3 id="å‡†å¤‡å…¶ä»–ç›®å½•"><a href="#å‡†å¤‡å…¶ä»–ç›®å½•" class="headerlink" title="å‡†å¤‡å…¶ä»–ç›®å½•"></a>å‡†å¤‡å…¶ä»–ç›®å½•</h3><p>åˆ›å»º upperdirï¼Œworkdir å’Œ merged</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> diff work merged</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„ç›®å½•ç»“æ„ï¼š</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">root@vagrant:~# tree -L 2</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ diff</span><br><span class="line">â”œâ”€â”€ merged</span><br><span class="line">â”œâ”€â”€ rootfs</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ dev</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ etc</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ home</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ media</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ mnt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ opt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ proc</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ root</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ run</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ sbin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ srv</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ sys</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ tmp</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ usr</span><br><span class="line">â”‚Â Â  â””â”€â”€ var</span><br><span class="line">â”œâ”€â”€ rootfs-init</span><br><span class="line">â”‚Â Â  â””â”€â”€ etc</span><br><span class="line">â””â”€â”€ work</span><br><span class="line"></span><br><span class="line">23 directories, 0 files</span><br></pre></td></tr></table></figure><h3 id="æ‰‹åŠ¨æŒ‚è½½"><a href="#æ‰‹åŠ¨æŒ‚è½½" class="headerlink" title="æ‰‹åŠ¨æŒ‚è½½"></a>æ‰‹åŠ¨æŒ‚è½½</h3><p>å°†å‡†å¤‡å¥½çš„ç›®å½•æŒ‚åœ¨åˆ° merged:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mount overlay -t overlay -o lowerdir=/root/rootfs-init:/root/rootfs,upperdir=/root/diff,workdir=/root/work /root/merged</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨å®¹å™¨"><a href="#ä½¿ç”¨å®¹å™¨" class="headerlink" title="ä½¿ç”¨å®¹å™¨"></a>ä½¿ç”¨å®¹å™¨</h3><p>åˆ©ç”¨ chroot æ”¹å˜æ ¹æ–‡ä»¶ç³»ç»Ÿ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> merged</span><br><span class="line"><span class="built_in">chroot</span> <span class="variable">$PWD</span> apk update</span><br><span class="line"><span class="built_in">chroot</span> <span class="variable">$PWD</span> apk upgrade</span><br><span class="line"><span class="built_in">chroot</span> <span class="variable">$PWD</span> apk add gcc</span><br><span class="line"><span class="built_in">chroot</span> <span class="variable">$PWD</span> gcc -v</span><br><span class="line"><span class="built_in">chroot</span> <span class="variable">$PWD</span> apk add neofetch</span><br><span class="line"><span class="built_in">chroot</span> <span class="variable">$PWD</span> neofetch</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»é€šè¿‡ OverlayFS å’Œ chroot å®ç°äº†ä¸€ä¸ªç®€æ˜“çš„å®¹å™¨</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">root@vagrant:~# tree -L 2</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ diff</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ dev</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ etc</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ root</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ usr</span><br><span class="line">â”‚Â Â  â””â”€â”€ var</span><br><span class="line">â”œâ”€â”€ merged</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ dev</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ etc</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ home</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ media</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ mnt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ opt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ proc</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ root</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ run</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ sbin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ srv</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ sys</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ tmp</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ usr</span><br><span class="line">â”‚Â Â  â””â”€â”€ var</span><br><span class="line">â”œâ”€â”€ rootfs</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ dev</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ etc</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ home</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ media</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ mnt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ opt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ proc</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ root</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ run</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ sbin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ srv</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ sys</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ tmp</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ usr</span><br><span class="line">â”‚Â Â  â””â”€â”€ var</span><br><span class="line">â”œâ”€â”€ rootfs-init</span><br><span class="line">â”‚Â Â  â””â”€â”€ etc</span><br><span class="line">â””â”€â”€ work</span><br><span class="line">    â””â”€â”€ work</span><br><span class="line"></span><br><span class="line">48 directories, 0 files</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç¬¬ä¸€æ¬¡çŸ¥é“è¿™ä¸ªæ¦‚å¿µï¼Œæ˜¯ä½¿ç”¨ Docker æ—¶ï¼Œå®ƒé»˜è®¤ä½¿ç”¨çš„ Graph Driver æ˜¯ Overlay2ï¼Œå®¹å™¨çš„ rootfs å°±æ˜¯ç›´æ¥ä»¥ç›®å½•çš„å½¢å¼åœ¨å®¿ä¸»æœºä¸Šç»„ç»‡ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="äº‘è®¡ç®—" scheme="https://blog.zcchub.xyz/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
    
    <category term="Linux" scheme="https://blog.zcchub.xyz/tags/Linux/"/>
    
    <category term="Docker" scheme="https://blog.zcchub.xyz/tags/Docker/"/>
    
    <category term="OverlayFS" scheme="https://blog.zcchub.xyz/tags/OverlayFS/"/>
    
    <category term="chroot" scheme="https://blog.zcchub.xyz/tags/chroot/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Vagrant æ­å»ºå¼€å‘ç¯å¢ƒ</title>
    <link href="https://blog.zcchub.xyz/tool/vagrant/"/>
    <id>https://blog.zcchub.xyz/tool/vagrant/</id>
    <published>2021-10-12T08:02:32.000Z</published>
    <updated>2022-04-02T19:22:09.115Z</updated>
    
    <content type="html"><![CDATA[<p>å…¶å®åœ¨å­¦æ ¡çš„æ—¶å€™å°±å¼€å§‹è½»åº¦ä½¿ç”¨ Vagrantï¼Œä½†ä¹Ÿä»…ä»…ä½œä¸ºä¸€ä¸ªè™šæ‹Ÿæœºåˆ›å»ºæˆ–è€…å¼€å…³æœºçš„å·¥å…·ã€‚Vagrant åœ¨æ­å»º<strong>ä¸€æ¬¡æ€§</strong>ä½¿ç”¨çš„å¼€å‘ç¯å¢ƒæ—¶çœŸçš„éå¸¸éå¸¸æ–¹ä¾¿</p><span id="more"></span><h2 id="éœ€è¦å®‰è£…çš„å·¥å…·"><a href="#éœ€è¦å®‰è£…çš„å·¥å…·" class="headerlink" title="éœ€è¦å®‰è£…çš„å·¥å…·"></a>éœ€è¦å®‰è£…çš„å·¥å…·</h2><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cudmlydHVhbGJveC5vcmcv">VirtualBox<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cudmFncmFudHVwLmNvbS8=">Vagrant<i class="fa fa-external-link-alt"></i></span></li></ul><h2 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h2><blockquote><p>æ›´å…·ä½“çš„æ¨èçœ‹<span class="exturl" data-url="aHR0cHM6Ly93d3cudmFncmFudHVwLmNvbS9kb2Nz">å®˜æ–¹æ–‡æ¡£<i class="fa fa-external-link-alt"></i></span></p></blockquote><p>å¸¸ç”¨å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vagrant init bento/ubuntu-18.04 <span class="comment"># åˆ›å»ºé…ç½®æ–‡ä»¶å¹¶æŒ‡å®š box</span></span><br><span class="line">vagrant up                      <span class="comment"># å¼€æœº</span></span><br><span class="line">vagrant reload                  <span class="comment"># é‡å¯ï¼ˆé‡æ–°åŠ è½½é…ç½®ï¼‰</span></span><br><span class="line">vagrant halt                    <span class="comment"># å…³æœº</span></span><br><span class="line">vagrant destroy                 <span class="comment"># é”€æ¯è™šæ‹Ÿæœº</span></span><br><span class="line">vagrant box list                <span class="comment"># æ˜¾ç¤ºå·²ä¸‹è½½çš„ box</span></span><br><span class="line"></span><br><span class="line">vagrant <span class="built_in">suspend</span>                 <span class="comment"># æš‚åœ</span></span><br><span class="line">vagrant resume                  <span class="comment"># æ¢å¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ  boxï¼Œå…·ä½“çœ‹ vagrant box add -h</span></span><br><span class="line">vagrant box add [options] &lt;name, url, or path&gt;</span><br><span class="line">vagrant box remove &lt;name&gt; <span class="comment"># åˆ é™¤ box</span></span><br></pre></td></tr></table></figure><h3 id="box"><a href="#box" class="headerlink" title="box"></a>box</h3><p>æŒ‰ç…§ä¼ ç»Ÿæ–¹æ³•ï¼Œè£…ä¸€å°è™šæ‹Ÿæœºï¼Œå¿…é¡»å»æŸä¸ª Linux å‘è¡Œç‰ˆçš„å®˜ç½‘ä¸Šä¸‹è½½ ISO æ–‡ä»¶ï¼Œç„¶åæ‰“å¼€ VMware æˆ–è€… VirtualBoxï¼Œä½¿ç”¨ ISO ä¸€æ­¥ä¸€æ­¥åˆ›å»ºè™šæ‹Ÿæœºã€‚è€Œ Vagrant æä¾›äº†æ›´ç®€å•çš„å½¢å¼ï¼Œä¸€æ¡å‘½ä»¤å°±èƒ½ä» box åˆ›å»ºå¹¶å¯åŠ¨è™šæ‹Ÿæœº</p><p>å¯ä»¥åœ¨å®˜ç½‘<span class="exturl" data-url="aHR0cHM6Ly9hcHAudmFncmFudHVwLmNvbS9ib3hlcy9zZWFyY2g=">æœç´¢<i class="fa fa-external-link-alt"></i></span>ç°æˆçš„ box</p><h3 id="Vagrantfile"><a href="#Vagrantfile" class="headerlink" title="Vagrantfile"></a>Vagrantfile</h3><p>ç›¸å½“äºè™šæ‹Ÿæœºçš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥é…ç½®ç½‘ç»œã€å†…å­˜ã€CPUã€åŒæ­¥æ–‡ä»¶å¤¹ã€ç«¯å£æ˜ å°„ç­‰ï¼Œä½¿ç”¨ <code>vagrant init</code> åœ¨å½“å‰ç›®å½•åˆ›å»ºé…ç½®æ¨¡æ¿</p><p>ä¸€ä¸ªæœ€ç®€å•çš„é…ç½®æ–‡ä»¶å°±æ˜¯ä»…æŒ‡å®š boxï¼Œå…¶ä»–é»˜è®¤ï¼š</p><figure class="highlight rb"><figcaption><span>Vagrantfile</span></figcaption><table><tr><td class="code"><pre><span class="line">Vagrant.configure(<span class="string">&quot;2&quot;</span>) <span class="keyword">do</span> |<span class="params">config</span>|</span><br><span class="line">  config.vm.box = <span class="string">&quot;bento/ubuntu-18.04&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>æ¥ç€ <code>vagrant up</code> è¯»å–é…ç½®æ–‡ä»¶å¹¶è¿è¡Œè™šæ‹Ÿæœºï¼Œç„¶åå°±å¯ä»¥å»æ³¡æ¯å’–å•¡ï¼Œå…¶ä»–ä»€ä¹ˆä¹Ÿä¸ç”¨ç®¡ï¼Œä¸€åˆ‡äº¤ç»™ vagrantï¼ˆå‰ææ˜¯ç½‘ç»œç¯å¢ƒå¥½çš„æƒ…å†µä¸‹ï¼Œæ‡‚å¾—éƒ½æ‡‚ï¼Œæ€ä¹ˆä¿è¯è®¿é—®å¤–ç½‘çš„é€Ÿåº¦ ğŸ§±ï¼‰ï¼Œå½“ä¸å†éœ€è¦çš„æ—¶å€™è¿è¡Œ <code>vagrant destroy</code> é”€æ¯å³å¯ã€‚</p><h2 id="æ›´å¤æ‚çš„é…ç½®"><a href="#æ›´å¤æ‚çš„é…ç½®" class="headerlink" title="æ›´å¤æ‚çš„é…ç½®"></a>æ›´å¤æ‚çš„é…ç½®</h2><p>ä»¥æœ€è¿‘è‡ªå·±ç”¨çš„ golang + docker ç¯å¢ƒä¸ºä¾‹ï¼Œå…¶å®ä¸»è¦éƒ¨åˆ†å°±æ˜¯ä¸€ä¸ª shell è„šæœ¬ï¼Œç„¶åé…ç½®äº†ç§æœ‰ç½‘ç»œï¼Œä¿®æ”¹ç¡¬ä»¶ä¸º 1 CPU 2G å†…å­˜</p><p>shell è„šæœ¬é»˜è®¤æƒ…å†µä¸‹åªä¼šåœ¨ç¬¬ä¸€æ¬¡ <code>vagrant up</code> çš„æ—¶å€™æ‰§è¡Œ</p><figure class="highlight rb"><figcaption><span>Vagrantfile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- mode: ruby -*-</span></span><br><span class="line"><span class="comment"># vi: set ft=ruby :</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$script</span> = <span class="string">&lt;&lt;-&#x27;SCRIPT&#x27;</span></span><br><span class="line"><span class="string">echo &quot;Setting timezone to Asia/Shanghai...&quot;</span></span><br><span class="line"><span class="string">sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"><span class="string">echo &quot;Asia/Shanghai&quot; | sudo tee /etc/timezone</span></span><br><span class="line"><span class="string">date</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo &quot;Using Aliyun mirrors...&quot;</span></span><br><span class="line"><span class="string">sudo tee /etc/apt/sources.list &lt;&lt;-&#x27;EOF&#x27;</span></span><br><span class="line"><span class="string">deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">sudo apt-get update</span></span><br><span class="line"><span class="string"># Comment apt upgrade to make vagrant up faster</span></span><br><span class="line"><span class="string"># sudo apt-get -y upgrade</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo &quot;Installing Docker...&quot;</span></span><br><span class="line"><span class="string">sudo apt-get remove docker docker-engine docker.io</span></span><br><span class="line"><span class="string">sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span></span><br><span class="line"><span class="string">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span></span><br><span class="line"><span class="string">sudo add-apt-repository &quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</span></span><br><span class="line"><span class="string">sudo apt-get -y update</span></span><br><span class="line"><span class="string">sudo apt-get -y install docker-ce</span></span><br><span class="line"><span class="string">sudo mkdir -p /etc/docker</span></span><br><span class="line"><span class="string">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn/&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">sudo systemctl daemon-reload</span></span><br><span class="line"><span class="string">sudo systemctl restart docker</span></span><br><span class="line"><span class="string">sudo systemctl enable docker</span></span><br><span class="line"><span class="string"># Make sure we can actually use docker as the vagrant user</span></span><br><span class="line"><span class="string">sudo usermod -aG docker vagrant</span></span><br><span class="line"><span class="string">sudo docker --version</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo &quot;Installing Golang...&quot;</span></span><br><span class="line"><span class="string">GO_VERSION=1.17.2</span></span><br><span class="line"><span class="string">curl -sSL https://gomirrors.org/dl/go/go$&#123;GO_VERSION&#125;.linux-amd64.tar.gz -o /tmp/go.tgz</span></span><br><span class="line"><span class="string">sudo rm -rf /usr/local/go &amp;&amp; sudo tar -C /usr/local -xzf /tmp/go.tgz</span></span><br><span class="line"><span class="string">tee -a /home/vagrant/.profile &lt;&lt;-&#x27;EOF&#x27;</span></span><br><span class="line"><span class="string">export GOROOT=/usr/local/go</span></span><br><span class="line"><span class="string">export GOPATH=/home/vagrant/go</span></span><br><span class="line"><span class="string">export PATH=$PATH:$GOROOT/bin:$GOPATH/bin</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">source /home/vagrant/.profile</span></span><br><span class="line"><span class="string">go version</span></span><br><span class="line"><span class="string">go env -w GO111MODULE=on</span></span><br><span class="line"><span class="string">go env -w GOPROXY=https://goproxy.cn,https://goproxy.io,direct</span></span><br><span class="line"><span class="string">mkdir -p /home/vagrant/go/&#123;bin,pkg,src&#125;</span></span><br><span class="line"><span class="string">SCRIPT</span></span><br><span class="line"></span><br><span class="line">Vagrant.configure(<span class="string">&quot;2&quot;</span>) <span class="keyword">do</span> |<span class="params">config</span>|</span><br><span class="line">  config.vm.box = <span class="string">&quot;bento/ubuntu-18.04&quot;</span></span><br><span class="line">  config.vm.network <span class="string">&quot;private_network&quot;</span>, <span class="symbol">ip:</span> <span class="string">&quot;192.168.33.11&quot;</span></span><br><span class="line"></span><br><span class="line">  config.vm.provider <span class="string">&quot;virtualbox&quot;</span> <span class="keyword">do</span> |<span class="params">vb</span>|</span><br><span class="line">    vb.cpus = <span class="string">&quot;1&quot;</span></span><br><span class="line">    vb.memory = <span class="string">&quot;2048&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  config.vm.provision <span class="string">&quot;shell&quot;</span>, <span class="symbol">inline:</span> <span class="variable">$script</span>, <span class="symbol">privileged:</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;å…¶å®åœ¨å­¦æ ¡çš„æ—¶å€™å°±å¼€å§‹è½»åº¦ä½¿ç”¨ Vagrantï¼Œä½†ä¹Ÿä»…ä»…ä½œä¸ºä¸€ä¸ªè™šæ‹Ÿæœºåˆ›å»ºæˆ–è€…å¼€å…³æœºçš„å·¥å…·ã€‚Vagrant åœ¨æ­å»º&lt;strong&gt;ä¸€æ¬¡æ€§&lt;/strong&gt;ä½¿ç”¨çš„å¼€å‘ç¯å¢ƒæ—¶çœŸçš„éå¸¸éå¸¸æ–¹ä¾¿&lt;/p&gt;</summary>
    
    
    
    <category term="å¼€å‘å·¥å…·" scheme="https://blog.zcchub.xyz/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Vagrant" scheme="https://blog.zcchub.xyz/tags/Vagrant/"/>
    
    <category term="VirtualBox" scheme="https://blog.zcchub.xyz/tags/VirtualBox/"/>
    
  </entry>
  
  <entry>
    <title>å¼€å§‹ç¬¬ä¸€ä¸ª Pull Request</title>
    <link href="https://blog.zcchub.xyz/github/first-pr/"/>
    <id>https://blog.zcchub.xyz/github/first-pr/</id>
    <published>2021-09-18T07:52:39.000Z</published>
    <updated>2022-04-02T19:22:09.111Z</updated>
    
    <content type="html"><![CDATA[<p>git å‡ ä¹æ˜¯æ‰€æœ‰ç¨‹åºå‘˜å¿…é¡»æŒæ¡çš„ä¸€ä¸ªå·¥å…·ï¼Œä½†æ˜¯å§‹ç»ˆåœ¨æœ¬åœ°ç»ƒä¹ ä¼¼ä¹å‘ç°ä¸äº†å®ƒçœŸæ­£çš„å¼ºå¤§ï¼Œäºæ˜¯ç›®å…‰å°±è½¬å‘äº† GitHub è¿™ä¸ªæä¾›äº†ä»“åº“æ‰˜ç®¡æœåŠ¡çš„ç½‘ç«™ã€‚åœ¨ GitHub ä¸Šæˆ‘ä»¬èƒ½åˆ©ç”¨ git å’Œä¸–ç•Œå„åœ°çš„ç¨‹åºå‘˜åä½œå¼€å‘ï¼Œåˆ†äº«æœ‰è¶£çš„ä»£ç ã€‚</p><span id="more"></span><h2 id="Pull-Request"><a href="#Pull-Request" class="headerlink" title="Pull Request"></a>Pull Request</h2><blockquote><p>GitHub ç®€å•çš„ä½¿ç”¨å°±ä¸èµ˜è¿°äº†ï¼Œè¿™ç¯‡ä¸»è¦åˆ†äº«ä¸€ä¸‹æˆ‘æ˜¯æ€ä¹ˆä»ä¸€ä¸ªäººé»˜é»˜ç©â€œå•æœºç‰ˆ GitHubâ€ï¼Œåˆ°ç¬¬ä¸€æ¬¡ç»™åˆ«äººçš„é¡¹ç›®æäº¤ pr</p></blockquote><p>é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯ pr (pull request) ï¼Ÿåœ¨æœ¬åœ°ä½¿ç”¨ git çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ª merge åŠŸèƒ½ï¼Œèƒ½å¤Ÿè¿›è¡Œåˆ†æ”¯åˆå¹¶ï¼Œpr å°±æ˜¯ GitHub ä¸Šçš„ mergeï¼Œå®ƒå¢åŠ äº†ä»£ç  review å’Œ CI&#x2F;CD ç­‰åŠŸèƒ½ã€‚é€šè¿‡ pr æˆ‘ä»¬å¯ä»¥ç»™åˆ«äººçš„é¡¹ç›®æ–°å¢åŠŸèƒ½ã€ä¿®å¤ bugï¼Œåœ¨é¡¹ç›®ç»´æŠ¤è€… review å®Œä½ çš„ä»£ç ï¼Œé€šè¿‡å¹¶ä¸”åˆå¹¶äº†è¿™æ¬¡ prï¼Œä½ å°±èƒ½æˆä¸ºè¿™ä¸ªé¡¹ç›®çš„ contributor (è´¡çŒ®è€…)</p><h2 id="æˆ‘çš„ç¬¬ä¸€æ¬¡-PR"><a href="#æˆ‘çš„ç¬¬ä¸€æ¬¡-PR" class="headerlink" title="æˆ‘çš„ç¬¬ä¸€æ¬¡ PR"></a>æˆ‘çš„ç¬¬ä¸€æ¬¡ PR</h2><p>ç© GitHub çš„ç¨‹åºå‘˜è‚¯å®šå¤šå¤šå°‘å°‘å¸Œæœ›è‡ªå·±çš„ä»“åº“èƒ½æœ‰å¾ˆå¤š â­ï¼Œæˆ‘ä¹Ÿä¸ä¾‹å¤–ï¼Œä½†æ˜¯æ— å¥ˆæŠ€æœ¯è¿˜æ²¡è¾¾åˆ°å¤§ä½¬çš„çº§åˆ«ï¼Œå†™ä¸å‡ºä»€ä¹ˆå¥½çš„é¡¹ç›®æˆ–è€…æ¡†æ¶ã€‚ä¸€æ¬¡é€› GitHub å‘ç°åˆ«äººæ•´ç†çš„åŠ›æ‰£çƒ­é—¨é—®é¢˜çš„ Go è¯­è¨€é¢˜è§£ï¼Œè·å¾—äº†æŒºå¤šæ˜Ÿæ˜Ÿï¼Œäºæ˜¯å°±æƒ³è‡ªå·±ä¹Ÿæ•´ç†ä¸€ä¸ª Java ç‰ˆæœ¬çš„ã€‚ä½†ä¹Ÿæ˜¯ä¸‰åˆ†çƒ­åº¦ï¼Œå†™äº†å‡ å‘¨å°±æ²¡åšæŒä¸‹å»ï¼Œåæ¥å¶ç„¶çœ‹åˆ°äº†<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lhbmdsYm1l">æ¨ç«‹æ»¨<i class="fa fa-external-link-alt"></i></span>å¤§ä½¬ç»´æŠ¤çš„ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Rvb2NzL2xlZXRjb2Rl">doocs&#x2F;leetcode<i class="fa fa-external-link-alt"></i></span>ï¼Œè¢« README é‡Œçš„<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Rvb2NzL2xlZXRjb2RlIyVFNSU4QSVBMCVFNSU4NSVBNSVFNiU4OCU5MSVFNCVCQiVBQw==">åŠ å…¥æˆ‘ä»¬<i class="fa fa-external-link-alt"></i></span>å¸å¼•åˆ°äº†ï¼š</p><p><img data-src="https://cdn.jsdelivr.net/gh/MaoLongLong/images/202111161308204.png" loading="lazy"></p><p>è¿ˆå‡ºç¬¬ä¸€æ­¥ç¡®å®æŒºç´§å¼ ï¼ŒæŸ¥äº†å¥½å¤šèµ„æ–™ï¼Œç„¶åç…§ç€ README é‡Œçš„æ­¥éª¤æ‰“å¼€äº†äººç”Ÿç¬¬ä¸€æ¬¡ pr (<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Rvb2NzL2xlZXRjb2RlL3B1bGwvMzU5">#359<i class="fa fa-external-link-alt"></i></span>)ï¼Œè™½ç„¶æœ‰äº›é”™è¯¯ï¼Œä½†æ˜¯åœ¨å¤§ä½¬çš„æŒ‡ç‚¹ä¸‹è¿˜æ˜¯æ”¹æ­£äº†è¿‡æ¥ï¼ŒæˆåŠŸè¢«åˆå¹¶ã€‚</p><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>è‡ªå·±çš„ä¸€äº›å°ç»éªŒï¼Œä¸€æ¬¡è§„èŒƒçš„ pr ä¸ä»…å‡å°‘äº†è‡ªå·±é‡å¤ä¿®æ”¹çš„æ¬¡æ•°ï¼Œä¹Ÿæ–¹ä¾¿äº†é¡¹ç›®ç»´æŠ¤è€… review</p><h3 id="ä»£ç æ ¼å¼"><a href="#ä»£ç æ ¼å¼" class="headerlink" title="ä»£ç æ ¼å¼"></a>ä»£ç æ ¼å¼</h3><p>å¯èƒ½æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„ç¼–ç¨‹ä¹ æƒ¯ï¼Œå·¦å¤§æ‹¬å·æ¢è¡Œæˆ–æ˜¯ä¸æ¢è¡Œï¼Œ2 ç©ºæ ¼ç¼©è¿›æˆ–æ˜¯ 4 ç©ºæ ¼ç¼©è¿›ã€‚è‡ªå·±æ•²ä»£ç çš„æ—¶å€™å¯ä»¥æŒ‰ä¹ æƒ¯æ¥ï¼Œä½†æ˜¯åœ¨æäº¤å‰æœ€å¥½æŒ‰ç…§é¡¹ç›®çš„æ ‡å‡†æ ¼å¼åŒ–ä¸€éï¼ˆè‡ªå·±é…ç½®å¥½æ ¼å¼åŒ–å·¥å…·æˆ–è€…ä½¿ç”¨é¡¹ç›®æä¾›çš„æ ¼å¼åŒ–é…ç½®ï¼‰</p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>é¡¹ç›®æœ‰å•å…ƒæµ‹è¯•ï¼Œä¿®æ”¹äº†ä»£ç åï¼Œç¡®ä¿å•å…ƒæµ‹è¯•è·‘çš„é€šï¼Œä¸è¦æäº¤ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„ bugã€‚å¦‚æœæ˜¯æ–‡æ¡£ç±»é¡¹ç›®ï¼Œæœ€å¥½åœ¨æœ¬åœ°é¢„è§ˆä¸€éï¼ˆé™¤éä½ å¾ˆç†Ÿç»ƒï¼Œç›¸ä¿¡è‡ªå·±ä¸ä¼šåœ¨ markdown é‡Œéƒ½å†™å‡º bugï¼‰</p><h3 id="Commit-Message"><a href="#Commit-Message" class="headerlink" title="Commit Message"></a>Commit Message</h3><p>å¤§éƒ¨åˆ†é¡¹ç›®å¯¹ commit message ä¼šæœ‰ä¸€å®šè¦æ±‚ï¼Œå¯ä»¥å­¦ä¹ ä¸€ä¸‹ Angular çš„ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci9ibG9iLzEyLjIuNi9DT05UUklCVVRJTkcubWQjY29tbWl0">Commit Message Format<i class="fa fa-external-link-alt"></i></span>ã€‚å¦å¤–å¯ä»¥ä½¿ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NvbW1pdGl6ZW4vY3otY2xp">cz-cli<i class="fa fa-external-link-alt"></i></span> å¾ˆæ–¹ä¾¿åœ°å†™å‡ºè§„èŒƒçš„ commit message:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… cz-cli (å‰æå¾—å…ˆè£…å¥½ node.js)</span></span><br><span class="line">npm i -g commitizen cz-conventional-changelog</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&#123; &quot;path&quot;: &quot;cz-conventional-changelog&quot; &#125;&#x27;</span> &gt; ~/.czrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åƒå¾€å¸¸ä¸€æ · add ç„¶å commit (commit æ”¹ä¸º cz)</span></span><br><span class="line">git add .</span><br><span class="line">git cz</span><br></pre></td></tr></table></figure><p>æ²¡äººä¸å–œæ¬¢è¿™æ ·æ¸…æ™°çš„ commits:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> --oneline</span><br><span class="line">007059963 (HEAD -&gt; main, origin/main, origin/HEAD) feat: add solutions to lc/lcof2 problem: Asteroid Collision</span><br><span class="line">92e73c337 chore: update contributors to @doocs/leetcode</span><br><span class="line">8453df21d feat: add solutions to lc problem: No.0825.Friends Of Appropriate Ages</span><br><span class="line">f8ea6eb9d feat: add solutions to lcof2 problem:No.075</span><br><span class="line">362159f22 feat: add solutions to lc problems: No.0912,1122</span><br><span class="line">89d6e7117 feat: add solutions to lc problem: No.1869.Longer Contiguous Segments of Ones than Zeros</span><br><span class="line">b680b612c feat: add solutions to lc problem: No.1051.Height Checker</span><br><span class="line">f4ccd19bd feat: add solutions to lc problem: No.0912.Sort an Array</span><br><span class="line">2e803a22b feat: add solutions to lcof2 problem: No.046</span><br><span class="line">6421c40d3 chore: update contributors to @doocs/leetcode</span><br><span class="line">f41bad246 feat: add cpp solution to lcof2 problem: NO.046 (<span class="comment">#567)</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æ‰“ä¸€æ³¢å¹¿å‘Šï¼Œæ¬¢è¿å–œæ¬¢åˆ·é¢˜çš„å°ä¼™ä¼´åŠ å…¥æˆ‘ä»¬</p><p><a href="https://github.com/doocs/leetcode"><img data-src="https://github-readme-stats.vercel.app/api/pin/?username=doocs&repo=leetcode&show_owner=true" alt="leetcode" loading="lazy"></a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;git å‡ ä¹æ˜¯æ‰€æœ‰ç¨‹åºå‘˜å¿…é¡»æŒæ¡çš„ä¸€ä¸ªå·¥å…·ï¼Œä½†æ˜¯å§‹ç»ˆåœ¨æœ¬åœ°ç»ƒä¹ ä¼¼ä¹å‘ç°ä¸äº†å®ƒçœŸæ­£çš„å¼ºå¤§ï¼Œäºæ˜¯ç›®å…‰å°±è½¬å‘äº† GitHub è¿™ä¸ªæä¾›äº†ä»“åº“æ‰˜ç®¡æœåŠ¡çš„ç½‘ç«™ã€‚åœ¨ GitHub ä¸Šæˆ‘ä»¬èƒ½åˆ©ç”¨ git å’Œä¸–ç•Œå„åœ°çš„ç¨‹åºå‘˜åä½œå¼€å‘ï¼Œåˆ†äº«æœ‰è¶£çš„ä»£ç ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="GitHub" scheme="https://blog.zcchub.xyz/categories/GitHub/"/>
    
    
    <category term="LeetCode" scheme="https://blog.zcchub.xyz/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>ç†”æ–­å™¨æ¨¡å¼</title>
    <link href="https://blog.zcchub.xyz/golang/gobreaker/"/>
    <id>https://blog.zcchub.xyz/golang/gobreaker/</id>
    <published>2021-09-16T08:21:28.000Z</published>
    <updated>2022-04-02T19:22:09.111Z</updated>
    
    <content type="html"><![CDATA[<p>ç†”æ–­å™¨æ¨¡å¼æé«˜äº†ç³»ç»Ÿä»æ•…éšœæ¢å¤æ—¶çš„ç¨³å®šæ€§ï¼Œæœ€å°åŒ–äº†æ•…éšœå¯¹æ€§èƒ½çš„å½±å“ã€‚</p><h2 id="èƒŒæ™¯å’Œé—®é¢˜"><a href="#èƒŒæ™¯å’Œé—®é¢˜" class="headerlink" title="èƒŒæ™¯å’Œé—®é¢˜"></a>èƒŒæ™¯å’Œé—®é¢˜</h2><p>åœ¨å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸‹ï¼Œæ‰§è¡Œè¿œç¨‹è°ƒç”¨å¯èƒ½ä¼šé‡åˆ°å„ç§è¶…æ—¶æˆ–æ•…éšœï¼Œè™½ç„¶å¤§éƒ¨åˆ†æƒ…å†µè¿™äº›é—®é¢˜èƒ½åœ¨çŸ­æ—¶é—´å†…è‡ªåŠ¨æ¢å¤ï¼Œåªéœ€è¦é‡è¯•å‡ æ¬¡å°±èƒ½è°ƒç”¨æˆåŠŸã€‚ä½†æ˜¯ï¼Œæœ‰äº›é—®é¢˜éœ€è¦å¾ˆé•¿æ—¶é—´æ¥æ¢å¤æ—¶ï¼Œä¸æ–­é‡è¯•æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚ç›¸åï¼Œåº”ç”¨ç¨‹åºåº”è¯¥è¿…é€Ÿæ¥å—è¿™æ¬¡æ“ä½œå¤±è´¥ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„é”™è¯¯å¤„ç†ã€‚</p><p>æ­¤å¤–ï¼Œå¦‚æœä¸€ä¸ªæœåŠ¡éå¸¸ç¹å¿™ï¼Œç³»ç»Ÿçš„ä¸€ä¸ªéƒ¨åˆ†çš„æ•…éšœå¯èƒ½ä¼šå¯¼è‡´çº§è”æ•…éšœã€‚ä¾‹å¦‚ï¼ŒæœåŠ¡è°ƒç”¨æ–¹è®¾ç½®äº†è°ƒç”¨çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœæœåŠ¡åœ¨è¿™æ®µæ—¶é—´å†…æ²¡æœ‰è¿”å›å“åº”ï¼Œè°ƒç”¨æ–¹ç›´æ¥ç”¨é”™è¯¯æ¶ˆæ¯è¿›è¡Œå›å¤ã€‚è¿™ç§ç­–ç•¥å¯èƒ½ä¼šå¯¼è‡´è®¸å¤šåŒä¸€æ“ä½œçš„å¹¶å‘è¯·æ±‚è¢«é˜»å¡ï¼Œç›´åˆ°è¶…æ—¶ã€‚è¿™äº›è¢«é˜»å¡çš„è¯·æ±‚ä¼šå ç”¨ç€å¤§é‡çš„ç³»ç»Ÿèµ„æºï¼ˆå†…å­˜ï¼Œçº¿ç¨‹ï¼Œæ•°æ®åº“è¿æ¥ç­‰ï¼‰ï¼Œè¿™äº›èµ„æºè€—å°½ï¼Œå¯¼è‡´ç³»ç»Ÿä¸­éœ€è¦ä½¿ç”¨ç›¸åŒèµ„æºçš„å…¶ä»–æœåŠ¡å‡ºç°æ•…éšœã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¥½æ˜¯<strong>ç«‹å³</strong>è®©è°ƒç”¨å¤±è´¥ï¼Œåªæœ‰åœ¨å¯èƒ½æˆåŠŸæ—¶æ‰å°è¯•è°ƒç”¨æœåŠ¡ã€‚</p><span id="more"></span><div class="note warning"><p>è®¾ç½®ä¸€ä¸ªæ›´çŸ­çš„è¶…æ—¶å¯èƒ½æœ‰åŠ©äºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯è¶…æ—¶ä¸åº”è¯¥å¤ªçŸ­ï¼Œè¿™å¯èƒ½ä¼šè®©é‚£äº›æœ¬æ¥åº”è¯¥æˆåŠŸçš„è¯·æ±‚ä¹Ÿè¶…æ—¶ã€‚</p></div><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><p>ç†”æ–­å™¨ä½œä¸ºä¸€ä¸ªå¯èƒ½å¤±è´¥æ“ä½œçš„ä»£ç†ï¼Œç›‘æ§æœ€è¿‘å‘ç”Ÿæ•…éšœçš„æ•°é‡ï¼Œç„¶åä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥å†³å®šæ˜¯å¦å…è®¸æ“ä½œç»§ç»­ï¼Œé˜²æ­¢åº”ç”¨ç¨‹åºåå¤æ‰§è¡Œå¤±è´¥æ“ä½œã€‚</p><p>ç†”æ–­å™¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª<strong>çŠ¶æ€æœº</strong>ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹çŠ¶æ€ï¼š</p><ul><li><strong>Closedï¼š</strong>ç¨‹åºå¯ä»¥æ­£å¸¸å‘å‡ºè¯·æ±‚ï¼Œç†”æ–­å™¨ç»´æŠ¤æœ€è¿‘å¤±è´¥çš„æ¬¡æ•°ï¼Œå¦‚æœæ“ä½œè°ƒç”¨ä¸æˆåŠŸï¼Œåˆ™ç†”æ–­å™¨å¢åŠ æ­¤è®¡æ•°ã€‚å¦‚æœåœ¨ç»™å®šæ—¶é—´å†…ï¼Œå¤±è´¥æ¬¡æ•°è¶…è¿‡äº†æŒ‡å®šçš„é˜ˆå€¼ï¼ŒçŠ¶æ€æœºå°†å˜ä¸º <strong>Open</strong> çŠ¶æ€ã€‚æ­¤æ—¶ï¼Œå¯åŠ¨ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œåœ¨ä¸€å®šæ—¶é—´åï¼ŒçŠ¶æ€æœºå˜ä¸º <strong>Half-Open</strong> çŠ¶æ€ã€‚</li><li><strong>Openï¼š</strong>ç¨‹åºå‘å‡ºçš„è¯·æ±‚ä¼šç«‹å³å¤±è´¥ï¼Œå¹¶å‘ç¨‹åºè¿”å›å¼‚å¸¸ã€‚ï¼ˆç›¸å½“äºç”µé—¸è·³é—¸äº†ï¼‰</li><li><strong>Half-Openï¼š</strong>ç¨‹åºåªèƒ½æ‰§è¡Œæœ‰é™æ•°é‡çš„è¯·æ±‚æ“ä½œï¼Œå¦‚æœè¿™äº›è¯·æ±‚æˆåŠŸäº†ï¼ˆæ•…éšœå·²ç»æ¢å¤ï¼‰ï¼ŒçŠ¶æ€æœºå˜ä¸º <strong>Closed</strong> çŠ¶æ€ã€‚å¦‚æœè¯·æ±‚å¤±è´¥äº†ï¼ŒçŠ¶æ€æœºå˜ä¸º <strong>Open</strong> çŠ¶æ€ï¼Œå¹¶ä¸”é‡æ–°å¯åŠ¨è®¡æ—¶å™¨ã€‚</li></ul><p><img data-src="https://cdn.jsdelivr.net/gh/MaoLongLong/images/202111161309094.png" loading="lazy"></p><h2 id="Golang-å®ç°"><a href="#Golang-å®ç°" class="headerlink" title="Golang å®ç°"></a>Golang å®ç°</h2><p><a href="https://github.com/sony/gobreaker"><img data-src="https://github-readme-stats.vercel.app/api/pin/?username=sony&repo=gobreaker&show_owner=true" alt="gobreaker" loading="lazy"></a></p><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>Settings</code> ç»“æ„ä½“é…ç½®ç†”æ–­å™¨ï¼š</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Settings <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name          <span class="type">string</span></span><br><span class="line">    MaxRequests   <span class="type">uint32</span></span><br><span class="line">    Interval      time.Duration</span><br><span class="line">    Timeout       time.Duration</span><br><span class="line">    ReadyToTrip   <span class="function"><span class="keyword">func</span><span class="params">(counts Counts)</span></span> <span class="type">bool</span></span><br><span class="line">    OnStateChange <span class="function"><span class="keyword">func</span><span class="params">(name <span class="type">string</span>, from State, to State)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>MaxRequests</code>: <strong>Half-Open</strong> çŠ¶æ€ä¸‹çš„æœ€å¤§è¯·æ±‚æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 1</li><li><code>Interval</code>: <strong>Closed</strong> çŠ¶æ€ä¸‹æ¸…ç©ºè®¡æ•°å™¨çš„å‘¨æœŸï¼Œé»˜è®¤ä¸æ¸…ç©º</li><li><code>Timeout</code>: <strong>Open</strong> çŠ¶æ€è½¬ <strong>Half-Open</strong> çŠ¶æ€çš„æ—¶é—´ï¼Œé»˜è®¤ 60 ç§’</li><li><code>ReadyToTrip</code>: é€šè¿‡è®¡æ•°å™¨çš„ä¿¡æ¯åˆ¤æ–­æ˜¯å¦éœ€è¦ç†”æ–­ï¼Œé»˜è®¤è¿ç»­å¤±è´¥ 5 æ¬¡åç†”æ–­</li><li><code>OnStateChange</code>: çŠ¶æ€å˜åŒ–æ—¶çš„å›è°ƒ</li></ul><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;errors&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;math/rand&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/sony/gobreaker&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rand.Seed(time.Now().UnixNano())</span><br><span class="line"></span><br><span class="line">    cb := gobreaker.NewCircuitBreaker(gobreaker.Settings&#123;</span><br><span class="line">        ReadyToTrip: <span class="function"><span class="keyword">func</span><span class="params">(counts gobreaker.Counts)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">            failureRatio := <span class="type">float64</span>(counts.TotalFailures) / <span class="type">float64</span>(counts.Requests)</span><br><span class="line">            <span class="comment">// å¤±è´¥ç‡å¤§äº 60% æ—¶ç†”æ–­</span></span><br><span class="line">            <span class="keyword">return</span> counts.Requests &gt;= <span class="number">3</span> &amp;&amp; failureRatio &gt;= <span class="number">0.6</span></span><br><span class="line">        &#125;,</span><br><span class="line">        OnStateChange: <span class="function"><span class="keyword">func</span><span class="params">(_ <span class="type">string</span>, from, to gobreaker.State)</span></span> &#123;</span><br><span class="line">            log.Printf(<span class="string">&quot;from: %v, to: %v\n&quot;</span>, from, to)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        result, err := cb.Execute(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">            <span class="comment">// æ¨¡æ‹Ÿ 70% çš„å¤±è´¥ç‡</span></span><br><span class="line">            <span class="keyword">if</span> rand.Float64() &lt; <span class="number">0.7</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;some error&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>, <span class="literal">nil</span></span><br><span class="line">        &#125;)</span><br><span class="line">        log.Printf(<span class="string">&quot;result: %v, err: %v\n&quot;</span>, result, err)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">2021/09/16 15:23:24 result: &lt;nil&gt;, err: some error</span><br><span class="line">2021/09/16 15:23:25 result: &lt;nil&gt;, err: some error</span><br><span class="line">2021/09/16 15:23:26 from: closed, to: open</span><br><span class="line">2021/09/16 15:23:26 result: &lt;nil&gt;, err: some error</span><br><span class="line">2021/09/16 15:23:27 result: &lt;nil&gt;, err: circuit breaker is open</span><br><span class="line">2021/09/16 15:23:28 result: &lt;nil&gt;, err: circuit breaker is open</span><br><span class="line">2021/09/16 15:23:29 result: &lt;nil&gt;, err: circuit breaker is open</span><br><span class="line">2021/09/16 15:23:30 result: &lt;nil&gt;, err: circuit breaker is open</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h3 id="Execute-æµç¨‹"><a href="#Execute-æµç¨‹" class="headerlink" title="Execute æµç¨‹"></a>Execute æµç¨‹</h3><p>ç®€å•è¿‡ä¸€é <code>Execute()</code> çš„æµç¨‹ï¼Œè¯¦ç»†ä»£ç å¯ä»¥çœ‹ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NvbnkvZ29icmVha2VyL2Jsb2IvbWFzdGVyL2dvYnJlYWtlci5nbw==">gobreader.go<i class="fa fa-external-link-alt"></i></span>ï¼Œä¸åˆ° 400 è¡Œï¼Œå®ç°çš„éå¸¸ç®€æ´ã€‚</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cb *CircuitBreaker)</span></span> Execute(req <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>)) (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// å¢åŠ è®¡æ•°ï¼Œåˆ¤æ–­çŠ¶æ€</span></span><br><span class="line">    generation, err := cb.beforeRequest()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœç†”æ–­å™¨å·²ç» Openï¼Œåœ¨è¿™é‡Œå°±ä¼šç›´æ¥è¿”å› ErrOpenState</span></span><br><span class="line">        <span class="comment">// Half-Open çŠ¶æ€ä¸‹è¶…è¿‡æœ€å¤§è¯·æ±‚æ•°åˆ™è¿”å› ErrTooManyRequests</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        e := <span class="built_in">recover</span>()</span><br><span class="line">        <span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">            cb.afterRequest(generation, <span class="literal">false</span>)</span><br><span class="line">            <span class="built_in">panic</span>(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡ŒçœŸæ­£çš„æ“ä½œ</span></span><br><span class="line">    result, err := req()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¢åŠ è®¡æ•°ï¼Œè¾¾åˆ°é˜ˆå€¼å°±ç†”æ–­ï¼Œerr éç©ºè¡¨ç¤ºå¤±è´¥</span></span><br><span class="line">    cb.afterRequest(generation, err == <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">return</span> result, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æºç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ‰§è¡Œè¿‡ç¨‹åªæ˜¯ç®€å•åœ°é€šè¿‡ <code>err == nil</code> åˆ¤æ–­æˆåŠŸï¼Œå‡è®¾ä¸šåŠ¡çš„é€»è¾‘å¾ˆå¤æ‚ï¼Œéœ€è¦åŠ å…¥è‡ªå®šä¹‰çš„åˆ¤æ–­ï¼Œå¯ä»¥ç”¨ <code>TwoStepCircuitBreaker</code>ã€‚</p><h3 id="ä¸¤é˜¶æ®µç†”æ–­"><a href="#ä¸¤é˜¶æ®µç†”æ–­" class="headerlink" title="ä¸¤é˜¶æ®µç†”æ–­"></a>ä¸¤é˜¶æ®µç†”æ–­</h3><p>å’Œæ™®é€šç†”æ–­å™¨çš„ä½¿ç”¨å·®ä¸å¤šï¼Œ<code>Allow()</code> æ–¹æ³•åªæ˜¯è°ƒç”¨äº† <code>beforeRequest()</code>ï¼Œç„¶åè¿”å›å›è°ƒå‡½æ•° <code>done(success bool)</code> å’Œé”™è¯¯ä¿¡æ¯ï¼Œé€šè¿‡å›è°ƒå‡½æ•°æˆ‘ä»¬èƒ½æŠŠæ“ä½œæˆåŠŸä¸å¦å‘Šè¯‰ç†”æ–­å™¨ã€‚</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;math/rand&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/sony/gobreaker&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rand.Seed(time.Now().UnixNano())</span><br><span class="line"></span><br><span class="line">    cb := gobreaker.NewTwoStepCircuitBreaker(gobreaker.Settings&#123;</span><br><span class="line">        ReadyToTrip: <span class="function"><span class="keyword">func</span><span class="params">(counts gobreaker.Counts)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">            failureRatio := <span class="type">float64</span>(counts.TotalFailures) / <span class="type">float64</span>(counts.Requests)</span><br><span class="line">            <span class="keyword">return</span> counts.Requests &gt;= <span class="number">3</span> &amp;&amp; failureRatio &gt;= <span class="number">0.6</span></span><br><span class="line">        &#125;,</span><br><span class="line">        OnStateChange: <span class="function"><span class="keyword">func</span><span class="params">(_ <span class="type">string</span>, from, to gobreaker.State)</span></span> &#123;</span><br><span class="line">            log.Printf(<span class="string">&quot;from: %v, to: %v\n&quot;</span>, from, to)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        done, err := cb.Allow()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Printf(<span class="string">&quot;err: %v\n&quot;</span>, err)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        success := <span class="literal">true</span></span><br><span class="line">        <span class="keyword">if</span> rand.Float64() &lt; <span class="number">0.7</span> &#123;</span><br><span class="line">            log.Println(<span class="string">&quot;failure&quot;</span>)</span><br><span class="line">            success = <span class="literal">false</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.Println(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        done(success)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">2021/09/16 16:26:49 failure</span><br><span class="line">2021/09/16 16:26:50 failure</span><br><span class="line">2021/09/16 16:26:51 success</span><br><span class="line">2021/09/16 16:26:52 failure</span><br><span class="line">2021/09/16 16:26:52 from: closed, to: open</span><br><span class="line">2021/09/16 16:26:53 err: circuit breaker is open</span><br><span class="line">2021/09/16 16:26:54 err: circuit breaker is open</span><br><span class="line">2021/09/16 16:26:55 err: circuit breaker is open</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvcHJldmlvdXMtdmVyc2lvbnMvbXNwLW4tcC9kbjU4OTc4NCh2PXBhbmRwLjEwKQ==">Circuit Breaker Pattern<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NvbnkvZ29icmVha2Vy">gobreaker<i class="fa fa-external-link-alt"></i></span></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç†”æ–­å™¨æ¨¡å¼æé«˜äº†ç³»ç»Ÿä»æ•…éšœæ¢å¤æ—¶çš„ç¨³å®šæ€§ï¼Œæœ€å°åŒ–äº†æ•…éšœå¯¹æ€§èƒ½çš„å½±å“ã€‚&lt;/p&gt;
&lt;h2 id=&quot;èƒŒæ™¯å’Œé—®é¢˜&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯å’Œé—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯å’Œé—®é¢˜&quot;&gt;&lt;/a&gt;èƒŒæ™¯å’Œé—®é¢˜&lt;/h2&gt;&lt;p&gt;åœ¨å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸‹ï¼Œæ‰§è¡Œè¿œç¨‹è°ƒç”¨å¯èƒ½ä¼šé‡åˆ°å„ç§è¶…æ—¶æˆ–æ•…éšœï¼Œè™½ç„¶å¤§éƒ¨åˆ†æƒ…å†µè¿™äº›é—®é¢˜èƒ½åœ¨çŸ­æ—¶é—´å†…è‡ªåŠ¨æ¢å¤ï¼Œåªéœ€è¦é‡è¯•å‡ æ¬¡å°±èƒ½è°ƒç”¨æˆåŠŸã€‚ä½†æ˜¯ï¼Œæœ‰äº›é—®é¢˜éœ€è¦å¾ˆé•¿æ—¶é—´æ¥æ¢å¤æ—¶ï¼Œä¸æ–­é‡è¯•æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚ç›¸åï¼Œåº”ç”¨ç¨‹åºåº”è¯¥è¿…é€Ÿæ¥å—è¿™æ¬¡æ“ä½œå¤±è´¥ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„é”™è¯¯å¤„ç†ã€‚&lt;/p&gt;
&lt;p&gt;æ­¤å¤–ï¼Œå¦‚æœä¸€ä¸ªæœåŠ¡éå¸¸ç¹å¿™ï¼Œç³»ç»Ÿçš„ä¸€ä¸ªéƒ¨åˆ†çš„æ•…éšœå¯èƒ½ä¼šå¯¼è‡´çº§è”æ•…éšœã€‚ä¾‹å¦‚ï¼ŒæœåŠ¡è°ƒç”¨æ–¹è®¾ç½®äº†è°ƒç”¨çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœæœåŠ¡åœ¨è¿™æ®µæ—¶é—´å†…æ²¡æœ‰è¿”å›å“åº”ï¼Œè°ƒç”¨æ–¹ç›´æ¥ç”¨é”™è¯¯æ¶ˆæ¯è¿›è¡Œå›å¤ã€‚è¿™ç§ç­–ç•¥å¯èƒ½ä¼šå¯¼è‡´è®¸å¤šåŒä¸€æ“ä½œçš„å¹¶å‘è¯·æ±‚è¢«é˜»å¡ï¼Œç›´åˆ°è¶…æ—¶ã€‚è¿™äº›è¢«é˜»å¡çš„è¯·æ±‚ä¼šå ç”¨ç€å¤§é‡çš„ç³»ç»Ÿèµ„æºï¼ˆå†…å­˜ï¼Œçº¿ç¨‹ï¼Œæ•°æ®åº“è¿æ¥ç­‰ï¼‰ï¼Œè¿™äº›èµ„æºè€—å°½ï¼Œå¯¼è‡´ç³»ç»Ÿä¸­éœ€è¦ä½¿ç”¨ç›¸åŒèµ„æºçš„å…¶ä»–æœåŠ¡å‡ºç°æ•…éšœã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¥½æ˜¯&lt;strong&gt;ç«‹å³&lt;/strong&gt;è®©è°ƒç”¨å¤±è´¥ï¼Œåªæœ‰åœ¨å¯èƒ½æˆåŠŸæ—¶æ‰å°è¯•è°ƒç”¨æœåŠ¡ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Golang" scheme="https://blog.zcchub.xyz/categories/Golang/"/>
    
    
    <category term="å¾®æœåŠ¡" scheme="https://blog.zcchub.xyz/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>é«˜æ€§èƒ½å­—èŠ‚æ±  - bytebufferpool æºç åˆ†æ</title>
    <link href="https://blog.zcchub.xyz/golang/bytebufferpool/"/>
    <id>https://blog.zcchub.xyz/golang/bytebufferpool/</id>
    <published>2021-06-28T08:19:02.000Z</published>
    <updated>2022-04-02T19:22:09.111Z</updated>
    
    <content type="html"><![CDATA[<!-- START doctoc generated TOC please keep comment here to allow auto update --><!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --><ul><li><a href="#%E7%AE%80%E4%BB%8B">ç®€ä»‹</a></li><li><a href="#%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0">ç®€å•å®ç°</a><ul><li><a href="#minio-bytepoolcap">MinIO BytePoolCap</a></li><li><a href="#syncpool">sync.Pool</a></li></ul></li><li><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90">é—®é¢˜åˆ†æ</a></li><li><a href="#bytebufferpool">ByteBufferPool</a></li><li><a href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95">æ€§èƒ½æµ‹è¯•</a></li><li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li></ul><!-- END doctoc generated TOC please keep comment here to allow auto update --><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>ä»Šå¤©çš„ä¸»è§’æ˜¯ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3ZhbHlhbGEvYnl0ZWJ1ZmZlcnBvb2w=">bytebufferpool<i class="fa fa-external-link-alt"></i></span> ï¼Œä»“åº“çš„ README æ–‡ä»¶æ˜¯è¿™ä¹ˆæè¿° bytebufferpool çš„ï¼š</p><blockquote><p>Currently bytebufferpool is fastest and most effective buffer pool written in Go.</p></blockquote><span id="more"></span><p>bytebufferpool åŸºæœ¬ä¸Šæ˜¯ç›®å‰ Go å®ç°çš„æœ€å¿«çš„å­—èŠ‚æ± ï¼Œåœ¨è®¸å¤šä¼˜ç§€é¡¹ç›®ä¸­éƒ½æœ‰è¢«ä½¿ç”¨ï¼ˆ<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3ZhbHlhbGEvZmFzdGh0dHA=">fasthttp<i class="fa fa-external-link-alt"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3ZhbHlhbGEvcXVpY2t0ZW1wbGF0ZQ==">quicktemplate<i class="fa fa-external-link-alt"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BhbmpmMjAwMC9nbmV0">gnet<i class="fa fa-external-link-alt"></i></span>ï¼‰</p><p>ä»€ä¹ˆæ˜¯å­—èŠ‚æ± ï¼Ÿåœ¨è¯»å–æ–‡ä»¶æˆ–è€…ä» <code>io.Reader</code> è·å–æ•°æ®æ—¶ï¼Œä¸€èˆ¬éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡ <code>[]byte</code> ä½œä¸ºç¼“å†²ï¼Œå¦‚æœå¯¹äºè¿™ç§æ–¹æ³•æœ‰å¤§é‡çš„è°ƒç”¨ï¼Œå°±ä¼šé¢‘ç¹åœ°åˆ›å»º <code>[]byte</code> ï¼Œè¿™éœ€è¦å¤ªå¤šå†…å­˜çš„ç”³è¯·å’Œé‡Šæ”¾ï¼Œå¢å¤§äº† GC çš„å‹åŠ›ã€‚è¿™ä¸ªæ—¶å€™â€œæ± åŒ–â€æŠ€æœ¯å°±æ´¾ä¸Šäº†ç”¨åœºï¼Œé€šè¿‡å¤ç”¨å¯¹è±¡ä»¥å‡å°‘å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ã€‚</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r, _ := os.Open(<span class="string">&quot;./main.go&quot;</span>)</span><br><span class="line">    <span class="comment">// æ™®é€šæ–¹å¼</span></span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">64</span>)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        n, err := r.Read(buf)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            log.Fatal(err)</span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Print(<span class="type">string</span>(buf[:n]))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç®€å•å®ç°"><a href="#ç®€å•å®ç°" class="headerlink" title="ç®€å•å®ç°"></a>ç®€å•å®ç°</h2><h3 id="MinIO-BytePoolCap"><a href="#MinIO-BytePoolCap" class="headerlink" title="MinIO BytePoolCap"></a>MinIO BytePoolCap</h3><p>MinIO ä¸­ä½¿ç”¨ <code>channel</code> å®ç°äº†ä¸€ä¸ªéå¸¸ç®€å•çš„<strong>æœ‰ç•Œ</strong>å­—èŠ‚æ±  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21pbmlvL21pbmlvL2Jsb2IvbWFzdGVyL2ludGVybmFsL2Jwb29sL2Jwb29sLmdv">bpool<i class="fa fa-external-link-alt"></i></span></p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> BytePoolCap <span class="keyword">struct</span> &#123;</span><br><span class="line">    c    <span class="keyword">chan</span> []<span class="type">byte</span></span><br><span class="line">    w    <span class="type">int</span></span><br><span class="line">    wcap <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBytePoolCap</span><span class="params">(maxSize <span class="type">int</span>, width <span class="type">int</span>, capwidth <span class="type">int</span>)</span></span> (bp *BytePoolCap) &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;BytePoolCap&#123;</span><br><span class="line">        c:    <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="type">byte</span>, maxSize),</span><br><span class="line">        w:    width,</span><br><span class="line">        wcap: capwidth,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>c</code> ç”¨æ¥å­˜æ”¾å­—èŠ‚åˆ‡ç‰‡ï¼ˆè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ<strong>æœ‰ç•Œ</strong>çš„åŸå› ï¼‰</li><li><code>w</code> è¡¨ç¤ºåˆ›å»ºå­—èŠ‚åˆ‡ç‰‡çš„ <code>len</code></li><li><code>wcap</code> è¡¨ç¤ºåˆ›å»ºå­—èŠ‚åˆ‡ç‰‡çš„ <code>cap</code></li></ul><p><code>Get()</code> æ–¹æ³•, ä»æ± ä¸­è·å–å­—èŠ‚åˆ‡ç‰‡ï¼š</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bp *BytePoolCap)</span></span> Get() (b []<span class="type">byte</span>) &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> b = &lt;-bp.c:</span><br><span class="line">        <span class="comment">// channel ä¸­å­˜åœ¨ []byte åˆ™å¤ç”¨</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// å¦åˆ™åˆ›å»º []byte</span></span><br><span class="line">        <span class="keyword">if</span> bp.wcap &gt; <span class="number">0</span> &#123;</span><br><span class="line">            b = <span class="built_in">make</span>([]<span class="type">byte</span>, bp.w, bp.wcap)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            b = <span class="built_in">make</span>([]<span class="type">byte</span>, bp.w)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Put([]byte)</code> æ–¹æ³•ï¼Œå°†ä½¿ç”¨å®Œçš„åˆ‡ç‰‡æ”¾å›æ± ä¸­ï¼Œä»¥è¢«ä¸‹ä¸€æ¬¡è·å–ï¼š</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bp *BytePoolCap)</span></span> Put(b []<span class="type">byte</span>) &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> bp.c &lt;- b:</span><br><span class="line">        <span class="comment">// channel æ”¾å¾—ä¸‹</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// channel æ”¾ä¸ä¸‹çš„è¯åˆ™ä¸è¿›è¡Œä»»ä½•æ“ä½œï¼Œç›´æ¥ä¸¢å¼ƒè¿™ä¸ª []byte</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¤šä¸ª goroutine å…¬ç”¨ä¸€ä¸ª pool</span></span><br><span class="line"><span class="keyword">var</span> bp = bpool.NewBytePoolCap(<span class="number">100</span>, <span class="number">64</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// func ...</span></span><br><span class="line">buf := bp.Get()</span><br><span class="line"><span class="keyword">defer</span> bp.Put(buf)</span><br><span class="line"></span><br><span class="line"><span class="comment">// use buf ...</span></span><br></pre></td></tr></table></figure><h3 id="sync-Pool"><a href="#sync-Pool" class="headerlink" title="sync.Pool"></a>sync.Pool</h3><p>è°ˆåˆ°â€œæ± â€ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ° Go æ ‡å‡†åº“ä¸­çš„ <code>sync.Pool</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å‡ è¡Œä»£ç å°±å®ç°ä¸€ä¸ªç®€å•çš„å­—èŠ‚æ± ï¼š</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">pool := &amp;sync.Pool&#123;</span><br><span class="line">    New: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">64</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥ä½¿ç”¨ <code>pool.Get().([]byte)</code> ä»æ± ä¸­å–å­—èŠ‚åˆ‡ç‰‡ï¼Œä½¿ç”¨å®Œåè°ƒç”¨ <code>pool.Put(buf)</code> å½’è¿˜åˆ°æ± ä¸­ã€‚</p><h2 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h2><p>ä¸Šé¢çš„ä¸¤ç§å­—èŠ‚æ± å®ç°éƒ½å­˜åœ¨è®¸å¤šé—®é¢˜ï¼šæ± ä¸­æ–°å»ºçš„å­—èŠ‚åˆ‡ç‰‡çš„ <code>len</code> å’Œ <code>cap</code> éƒ½æ˜¯åˆ›å»ºæ± çš„æ—¶å€™å›ºå®šçš„ï¼Œä¸èƒ½åŠ¨æ€ä¿®æ”¹ã€‚å¦å¤–ï¼Œå¦‚æœå¾€å­—èŠ‚åˆ‡ç‰‡å†™å…¥äº†å¤§é‡æ•°æ®ï¼ˆå‘ç”Ÿå¤šæ¬¡æ‰©å®¹ï¼‰ï¼Œæ­¤æ—¶å†å°†è¿™æ ·çš„å­—èŠ‚åˆ‡ç‰‡æ”¾å›æ± ä¸­ï¼Œæ˜¾ç„¶ä¼šé€ æˆå†…å­˜æµªè´¹ã€‚</p><p>æ‰€ä»¥éœ€è¦è§£å†³çš„é—®é¢˜ï¼š</p><ol><li>åŠ¨æ€ä¿®æ”¹æ–°åˆ†é…å­—èŠ‚åˆ‡ç‰‡çš„å¤§å°</li><li>é˜»æ­¢å¤§åˆ‡ç‰‡æ”¾å›å­—èŠ‚æ± </li></ol><h2 id="ByteBufferPool"><a href="#ByteBufferPool" class="headerlink" title="ByteBufferPool"></a>ByteBufferPool</h2><p>ByteBufferPool ä¸­å®ç°äº†ä¸€ä¸ªç±»ä¼¼ <code>bytes.Buffer</code> çš„ç»“æ„ï¼ˆ<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3ZhbHlhbGEvYnl0ZWJ1ZmZlcnBvb2wvYmxvYi9tYXN0ZXIvYnl0ZWJ1ZmZlci5nbw==">ByteBuffer<i class="fa fa-external-link-alt"></i></span>ï¼‰ï¼Œå®ƒå°è£…äº†ä¸€äº›å¯¹ <code>[]byte</code> çš„å¤æ‚æ“ä½œï¼Œä» benchmark çš„ç»“æœå¯ä»¥çœ‹å‡ºå®ƒçš„æ€§èƒ½æ¯” <code>bytes.Buffer</code> ç•¥é«˜ä¸€äº›ï¼Œä½†å®ƒä¸æ˜¯å­—èŠ‚æ± çš„é‡ç‚¹ï¼Œæ‰€ä»¥å°±ä¸è´´ä»£ç äº†ã€‚</p><p>ByteBufferPool æ˜¯æ€ä¹ˆè§£å†³ä¸Šè¿°é—®é¢˜çš„ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    minBitSize = <span class="number">6</span>  <span class="comment">// 2**6=64 is a CPU cache line size</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† buf çš„å¤§å°åˆ’åˆ†ä¸º 20 ä¸ªåŒºé—´</span></span><br><span class="line">    <span class="comment">// ==&gt; (0, 64], (64, 128], (128, 256], ... , (8388608, 16777216], (16777216, 33554432]</span></span><br><span class="line">    <span class="comment">// è¶…è¿‡ 33554432 çš„ä¹Ÿå±äºæœ€åä¸€ä¸ªåŒºé—´</span></span><br><span class="line">    steps = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    minSize = <span class="number">1</span> &lt;&lt; minBitSize               <span class="comment">// 64</span></span><br><span class="line">    maxSize = <span class="number">1</span> &lt;&lt; (minBitSize + steps - <span class="number">1</span>) <span class="comment">// 33554432</span></span><br><span class="line"></span><br><span class="line">    calibrateCallsThreshold = <span class="number">42000</span></span><br><span class="line">    maxPercentile           = <span class="number">0.95</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</span><br><span class="line">    calls       [steps]<span class="type">uint64</span> <span class="comment">// ä¸åŒå¤§å° buf çš„ä½¿ç”¨é¢‘æ¬¡</span></span><br><span class="line">    calibrating <span class="type">uint64</span>        <span class="comment">// æ ‡è®°æ˜¯å¦æ­£åœ¨æ ¡å‡†ï¼ˆæ ¡å‡†è¿‡ç¨‹å°±æ˜¯è°ƒæ•´ defaultSize å’Œ maxSizeï¼‰</span></span><br><span class="line"></span><br><span class="line">    defaultSize <span class="type">uint64</span> <span class="comment">// make []byte æ—¶çš„ cap</span></span><br><span class="line">    maxSize     <span class="type">uint64</span> <span class="comment">// èƒ½æ”¾å›æ± ä¸­çš„æœ€å¤§ buf å¤§å°</span></span><br><span class="line"></span><br><span class="line">    pool sync.Pool <span class="comment">// å­˜å‚¨ buf</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span></span> Get() *ByteBuffer &#123;</span><br><span class="line">    v := p.pool.Get()</span><br><span class="line">    <span class="comment">// å¦‚æœæ± ä¸­æœ‰ buf ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> v != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> v.(*ByteBuffer)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦åˆ™æ–°å»ºä¸€ä¸ª cap ä¸º defaultSize çš„ buf</span></span><br><span class="line">    <span class="keyword">return</span> &amp;ByteBuffer&#123;</span><br><span class="line">        B: <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>, atomic.LoadUint64(&amp;p.defaultSize)),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­æŸ¥çœ‹ <code>Put()</code>ï¼Œä»è¿™å°±å¯ä»¥çœ‹å‡º ByteBufferPool çš„ä¸»è¦é€»è¾‘äº†ï¼š</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span></span> Put(b *ByteBuffer) &#123;</span><br><span class="line">    <span class="comment">// len æ‰€åœ¨ â€œåŒºé—´â€ çš„ä¸‹æ ‡</span></span><br><span class="line">    idx := index(<span class="built_in">len</span>(b.B))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£å†³äº†é—®é¢˜1ï¼šåŠ¨æ€è°ƒæ•´ size</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨é¢‘æ¬¡åŠ 1ï¼Œå¦‚æœè¶…è¿‡äº†é˜ˆå€¼ï¼ˆ42000ï¼‰åˆ™è¿›è¡Œæ ¡å‡†</span></span><br><span class="line">    <span class="keyword">if</span> atomic.AddUint64(&amp;p.calls[idx], <span class="number">1</span>) &gt; calibrateCallsThreshold &#123;</span><br><span class="line">        p.calibrate()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£å†³äº†é—®é¢˜2ï¼šé˜»æ­¢å¤§åˆ‡ç‰‡æ”¾å›å­—èŠ‚æ± </span></span><br><span class="line">    <span class="comment">// å¦‚æœè¿˜æœªè®¾ç½® maxSize æˆ– cap å°äºç­‰äº maxSize æ‰æ‰§è¡Œ Put</span></span><br><span class="line">    maxSize := <span class="type">int</span>(atomic.LoadUint64(&amp;p.maxSize))</span><br><span class="line">    <span class="keyword">if</span> maxSize == <span class="number">0</span> || <span class="built_in">cap</span>(b.B) &lt;= maxSize &#123;</span><br><span class="line">        b.Reset()</span><br><span class="line">        p.pool.Put(b)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">index</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    n--</span><br><span class="line">    n &gt;&gt;= minBitSize</span><br><span class="line">    idx := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> n &gt; <span class="number">0</span> &#123;</span><br><span class="line">        n &gt;&gt;= <span class="number">1</span></span><br><span class="line">        idx++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> idx &gt;= steps &#123;</span><br><span class="line">        idx = steps - <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> idx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ’åˆ†åŒºé—´çš„ç›®çš„å°±æ˜¯æ–¹ä¾¿ç»Ÿè®¡å‡ºç¨‹åºè¿‘ä¸€æ®µæ—¶é—´å†…<strong>æœ€ç»å¸¸ä½¿ç”¨</strong>å¤šå¤§çš„ bufï¼Œä»è€Œå†³å®š <code>defaultSize</code> å’Œ <code>maxSize</code>ï¼Œè¿™ä¸€å—çš„é€»è¾‘ä¸»è¦åœ¨ <code>calibrate()</code> ï¼š</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span></span> calibrate() &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡ CAS ç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª goroutine æ‰§è¡Œ calibrate</span></span><br><span class="line">    <span class="keyword">if</span> !atomic.CompareAndSwapUint64(&amp;p.calibrating, <span class="number">0</span>, <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    a := <span class="built_in">make</span>(callSizes, <span class="number">0</span>, steps)</span><br><span class="line">    <span class="comment">// æ‰€æœ‰å¤§å° buf çš„æ€»ä½¿ç”¨é¢‘æ¬¡</span></span><br><span class="line">    <span class="keyword">var</span> callsSum <span class="type">uint64</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="type">uint64</span>(<span class="number">0</span>); i &lt; steps; i++ &#123;</span><br><span class="line">        calls := atomic.SwapUint64(&amp;p.calls[i], <span class="number">0</span>)</span><br><span class="line">        callsSum += calls</span><br><span class="line">        a = <span class="built_in">append</span>(a, callSize&#123;</span><br><span class="line">            calls: calls,</span><br><span class="line">            size:  minSize &lt;&lt; i,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æŒ‰ç…§ä½¿ç”¨é¢‘æ¬¡ä»å¤§åˆ°å°æ’åº</span></span><br><span class="line">    sort.Sort(a)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† defaultSize è®¾ç½®ä¸ºé¢‘æ¬¡æœ€é«˜çš„ size</span></span><br><span class="line">    defaultSize := a[<span class="number">0</span>].size</span><br><span class="line">    maxSize := defaultSize</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€‰æ‹© maxSizeï¼Œè®© 95% çš„ buf éƒ½èƒ½è¢«å½’è¿˜åˆ°æ± ä¸­ï¼Œåªæœ‰æœ€å¤§çš„ %5 æ— æ³•å½’è¿˜</span></span><br><span class="line">    maxSum := <span class="type">uint64</span>(<span class="type">float64</span>(callsSum) * maxPercentile)</span><br><span class="line">    callsSum = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; steps; i++ &#123;</span><br><span class="line">        <span class="keyword">if</span> callsSum &gt; maxSum &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        callsSum += a[i].calls</span><br><span class="line">        size := a[i].size</span><br><span class="line">        <span class="keyword">if</span> size &gt; maxSize &#123;</span><br><span class="line">            maxSize = size</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å› ä¸º pool ä¼šè¢«å¤šä¸ª goroutine è®¿é—®ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åŸå­å†™å…¥</span></span><br><span class="line">    atomic.StoreUint64(&amp;p.defaultSize, defaultSize)</span><br><span class="line">    atomic.StoreUint64(&amp;p.maxSize, maxSize)</span><br><span class="line"></span><br><span class="line">    atomic.StoreUint64(&amp;p.calibrating, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> callSize <span class="keyword">struct</span> &#123;</span><br><span class="line">    calls <span class="type">uint64</span> <span class="comment">// ä½¿ç”¨é¢‘æ¬¡</span></span><br><span class="line">    size  <span class="type">uint64</span> <span class="comment">// buf å¤§å°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> callSizeSlice []callSize</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a callSizeSlice)</span></span> Len() <span class="type">int</span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(a) &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a callSizeSlice)</span></span> Swap(i, j <span class="type">int</span>)      &#123; a[i], a[j] = a[j], a[i] &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a callSizeSlice)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> &#123; <span class="keyword">return</span> a[i].calls &gt; a[j].calls &#125;</span><br></pre></td></tr></table></figure><h2 id="æ€§èƒ½æµ‹è¯•"><a href="#æ€§èƒ½æµ‹è¯•" class="headerlink" title="æ€§èƒ½æµ‹è¯•"></a>æ€§èƒ½æµ‹è¯•</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01hb0xvbmdMb25nL2J5dGVidWZmZXJwb29sL2Jsb2IvbWFpbi9wb29sX2JlbmNoX3Rlc3QuZ28=">pool_bench_test.go<i class="fa fa-external-link-alt"></i></span></p><p>ä»ä¸Šå¾€ä¸‹ï¼Œåˆ†åˆ«ä¸º ByteBufferPool, MinIO BytePoolCap å’Œæ™®é€š <code>[]byte</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ go <span class="built_in">test</span> -bench=Pool -benchmem</span><br><span class="line">goos: linux</span><br><span class="line">goarch: amd64</span><br><span class="line">pkg: github.com/maolonglong/bytebufferpool</span><br><span class="line">cpu: Intel(R) Core(TM) i7-7500U CPU @ 2.70GHz</span><br><span class="line">BenchmarkByteBufferPoolBuf-4    20764896                52.71 ns/op            0 B/op          0 allocs/op</span><br><span class="line">BenchmarkBPool-4                 7899157               156.4 ns/op             0 B/op          0 allocs/op</span><br><span class="line">BenchmarkWithoutPool-4           4511701               270.5 ns/op          1472 B/op          3 allocs/op</span><br><span class="line">PASS</span><br><span class="line">ok      github.com/maolonglong/bytebufferpool   4.091s</span><br></pre></td></tr></table></figure><p>ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹å‡ºï¼ŒByteBufferPool ä¸ç®¡åœ¨é€Ÿåº¦è¿˜æ˜¯å†…å­˜ä¸Šéƒ½ä¼˜äºå¦å¤–ä¸¤ç§æ–¹æ¡ˆã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>GitHub ä¸Šè®¸å¤šä¼˜ç§€çš„é¡¹ç›®å…¶å®ä»£ç å¹¶ä¸éš¾ï¼Œé€šè¿‡è¿™äº›é¡¹ç›®å¯ä»¥å­¦ä¹ å¤§ä½¬ä»¬è®¾è®¡ã€ä¼˜åŒ–ä»£ç çš„æ€æƒ³ï¼Œæå‡è‡ªå·±è§£å†³å®é™…é—®é¢˜çš„èƒ½åŠ›ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;!-- START doctoc generated TOC please keep comment here to allow auto update --&gt;
&lt;!-- DON&#39;T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%AE%80%E4%BB%8B&quot;&gt;ç®€ä»‹&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0&quot;&gt;ç®€å•å®ç°&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#minio-bytepoolcap&quot;&gt;MinIO BytePoolCap&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#syncpool&quot;&gt;sync.Pool&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90&quot;&gt;é—®é¢˜åˆ†æ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bytebufferpool&quot;&gt;ByteBufferPool&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95&quot;&gt;æ€§èƒ½æµ‹è¯•&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%80%BB%E7%BB%93&quot;&gt;æ€»ç»“&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;!-- END doctoc generated TOC please keep comment here to allow auto update --&gt;

&lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;ä»Šå¤©çš„ä¸»è§’æ˜¯ &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9naXRodWIuY29tL3ZhbHlhbGEvYnl0ZWJ1ZmZlcnBvb2w=&quot;&gt;bytebufferpool&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&lt;/span&gt; ï¼Œä»“åº“çš„ README æ–‡ä»¶æ˜¯è¿™ä¹ˆæè¿° bytebufferpool çš„ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Currently bytebufferpool is fastest and most effective buffer pool written in Go.&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Golang" scheme="https://blog.zcchub.xyz/categories/Golang/"/>
    
    
    <category term="pool" scheme="https://blog.zcchub.xyz/tags/pool/"/>
    
  </entry>
  
  <entry>
    <title>æ— é”é˜Ÿåˆ—çš„ç®€å•å®ç°</title>
    <link href="https://blog.zcchub.xyz/golang/lock-free-queue/"/>
    <id>https://blog.zcchub.xyz/golang/lock-free-queue/</id>
    <published>2021-06-25T08:16:59.000Z</published>
    <updated>2022-04-02T19:22:09.111Z</updated>
    
    <content type="html"><![CDATA[<p>è°ˆåˆ°æ— é”é˜Ÿåˆ—ï¼Œå°±ä¸å¾—ä¸æ Michael å’Œ Scott åœ¨ 1996 å¹´å‘è¡¨çš„è®ºæ–‡ <span class="exturl" data-url="aHR0cHM6Ly93d3cuY3Mucm9jaGVzdGVyLmVkdS91L3Njb3R0L3BhcGVycy8xOTk2X1BPRENfcXVldWVzLnBkZg==">Simple, Fast, and Practical Non-Blocking and Blocking Concurrent Queue Algorithms<i class="fa fa-external-link-alt"></i></span>ï¼ŒJava ä¸­ <code>ConcurrentLinkedQueue</code> ä¹Ÿæ˜¯åŸºäºè¯¥è®ºæ–‡çš„ç®—æ³•å®ç°ã€‚</p><span id="more"></span><h2 id="ä¼ªä»£ç "><a href="#ä¼ªä»£ç " class="headerlink" title="ä¼ªä»£ç "></a>ä¼ªä»£ç </h2><p>è®ºæ–‡ä¸­ lock-free queue ç®—æ³•çš„ä¼ªä»£ç ï¼š</p><p>æ­£å¦‚è®ºæ–‡çš„é¢˜ç›®æè¿°çš„ï¼Œå®ƒéå¸¸ç®€å•ï¼Œä»£ç é‡å¾ˆå°‘ã€‚ä¸»è¦æ€è·¯å°±æ˜¯ä½¿ç”¨ <span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU2JUFGJTk0JUU4JUJFJTgzJUU1JUI5JUI2JUU0JUJBJUE0JUU2JThEJUEy">CAS<i class="fa fa-external-link-alt"></i></span> æ“ä½œé˜Ÿåˆ—çš„å¤´æŒ‡é’ˆå’Œå°¾æŒ‡é’ˆï¼Œä»¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">structure pointer_t &#123;ptr: pointer to node_t, count: unsigned integer&#125;</span><br><span class="line">structure node_t &#123;value: data type, next: pointer_t&#125;</span><br><span class="line">structure queue_t &#123;Head: pointer_t, Tail: pointer_t&#125;</span><br><span class="line"></span><br><span class="line">initialize(Q: pointer to queue_t)</span><br><span class="line">   node = new_node()        // Allocate a free node</span><br><span class="line">   node-&gt;next.ptr = NULL    // Make it the only node in the linked list</span><br><span class="line">   Q-&gt;Head.ptr = Q-&gt;Tail.ptr = node    // Both Head and Tail point to it</span><br><span class="line"></span><br><span class="line">enqueue(Q: pointer to queue_t, value: data type)</span><br><span class="line"> E1:   node = new_node()    // Allocate a new node from the free list</span><br><span class="line"> E2:   node-&gt;value = value    // Copy enqueued value into node</span><br><span class="line"> E3:   node-&gt;next.ptr = NULL    // Set next pointer of node to NULL</span><br><span class="line"> E4:   loop            // Keep trying until Enqueue is done</span><br><span class="line"> E5:      tail = Q-&gt;Tail    // Read Tail.ptr and Tail.count together</span><br><span class="line"> E6:      next = tail.ptr-&gt;next    // Read next ptr and count fields together</span><br><span class="line"> E7:      if tail == Q-&gt;Tail    // Are tail and next consistent?</span><br><span class="line">             // Was Tail pointing to the last node?</span><br><span class="line"> E8:         if next.ptr == NULL</span><br><span class="line">                // Try to link node at the end of the linked list</span><br><span class="line"> E9:            if CAS(&amp;tail.ptr-&gt;next, next, &lt;node, next.count+1&gt;)</span><br><span class="line">E10:               break    // Enqueue is done.  Exit loop</span><br><span class="line">E11:            endif</span><br><span class="line">E12:         else        // Tail was not pointing to the last node</span><br><span class="line">                // Try to swing Tail to the next node</span><br><span class="line">E13:            CAS(&amp;Q-&gt;Tail, tail, &lt;next.ptr, tail.count+1&gt;)</span><br><span class="line">E14:         endif</span><br><span class="line">E15:      endif</span><br><span class="line">E16:   endloop</span><br><span class="line">       // Enqueue is done.  Try to swing Tail to the inserted node</span><br><span class="line">E17:   CAS(&amp;Q-&gt;Tail, tail, &lt;node, tail.count+1&gt;)</span><br><span class="line"></span><br><span class="line">dequeue(Q: pointer to queue_t, pvalue: pointer to data type): boolean</span><br><span class="line"> D1:   loop                 // Keep trying until Dequeue is done</span><br><span class="line"> D2:      head = Q-&gt;Head         // Read Head</span><br><span class="line"> D3:      tail = Q-&gt;Tail         // Read Tail</span><br><span class="line"> D4:      next = head.ptr-&gt;next    // Read Head.ptr-&gt;next</span><br><span class="line"> D5:      if head == Q-&gt;Head         // Are head, tail, and next consistent?</span><br><span class="line"> D6:         if head.ptr == tail.ptr // Is queue empty or Tail falling behind?</span><br><span class="line"> D7:            if next.ptr == NULL  // Is queue empty?</span><br><span class="line"> D8:               return FALSE      // Queue is empty, couldn&#x27;t dequeue</span><br><span class="line"> D9:            endif</span><br><span class="line">                // Tail is falling behind.  Try to advance it</span><br><span class="line">D10:            CAS(&amp;Q-&gt;Tail, tail, &lt;next.ptr, tail.count+1&gt;)</span><br><span class="line">D11:         else             // No need to deal with Tail</span><br><span class="line">                // Read value before CAS</span><br><span class="line">                // Otherwise, another dequeue might free the next node</span><br><span class="line">D12:            *pvalue = next.ptr-&gt;value</span><br><span class="line">                // Try to swing Head to the next node</span><br><span class="line">D13:            if CAS(&amp;Q-&gt;Head, head, &lt;next.ptr, head.count+1&gt;)</span><br><span class="line">D14:               break             // Dequeue is done.  Exit loop</span><br><span class="line">D15:            endif</span><br><span class="line">D16:         endif</span><br><span class="line">D17:      endif</span><br><span class="line">D18:   endloop</span><br><span class="line">D19:   free(head.ptr)             // It is safe now to free the old node</span><br><span class="line">D20:   return TRUE                   // Queue was not empty, dequeue succeeded</span><br></pre></td></tr></table></figure><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>ç®€å•èµ·è§ï¼Œä¸è€ƒè™‘ <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQUJBX3Byb2JsZW0=">ABA<i class="fa fa-external-link-alt"></i></span> é—®é¢˜ï¼Œæ‰€ä»¥æ²¡æœ‰å®ç°å¸¦ç‰ˆæœ¬å·çš„ CAS</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;sync/atomic&quot;</span></span><br><span class="line">    <span class="string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> lockFreeQueue <span class="keyword">struct</span> &#123;</span><br><span class="line">    head unsafe.Pointer</span><br><span class="line">    tail unsafe.Pointer</span><br><span class="line">    <span class="built_in">len</span>  <span class="type">int32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> node <span class="keyword">struct</span> &#123;</span><br><span class="line">    value <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    next  unsafe.Pointer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLockFreeQueue</span><span class="params">()</span></span> *lockFreeQueue &#123;</span><br><span class="line">    n := unsafe.Pointer(&amp;node&#123;&#125;)</span><br><span class="line">    <span class="keyword">return</span> &amp;lockFreeQueue&#123;head: n, tail: n&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *lockFreeQueue)</span></span> Enqueue(v <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">    n := &amp;node&#123;value: v&#125;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        tail := load(&amp;q.tail)</span><br><span class="line">        next := load(&amp;tail.next)</span><br><span class="line">        <span class="keyword">if</span> tail == load(&amp;q.tail) &#123;</span><br><span class="line">            <span class="keyword">if</span> next == <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> cas(&amp;tail.next, next, n) &#123;</span><br><span class="line">                    cas(&amp;q.tail, tail, n)</span><br><span class="line">                    atomic.AddInt32(&amp;q.<span class="built_in">len</span>, <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cas(&amp;q.tail, tail, next)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *lockFreeQueue)</span></span> Dequeue() <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        head := load(&amp;q.head)</span><br><span class="line">        tail := load(&amp;q.tail)</span><br><span class="line">        next := load(&amp;head.next)</span><br><span class="line">        <span class="keyword">if</span> head == load(&amp;q.head) &#123;</span><br><span class="line">            <span class="keyword">if</span> head == tail &#123;</span><br><span class="line">                <span class="keyword">if</span> next == <span class="literal">nil</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                &#125;</span><br><span class="line">                cas(&amp;q.tail, tail, next)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                v := next.value</span><br><span class="line">                <span class="keyword">if</span> cas(&amp;q.head, head, next) &#123;</span><br><span class="line">                    atomic.AddInt32(&amp;q.<span class="built_in">len</span>, <span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">return</span> v</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *lockFreeQueue)</span></span> Empty() <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> atomic.LoadInt32(&amp;q.<span class="built_in">len</span>) != <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">load</span><span class="params">(p *unsafe.Pointer)</span></span> *node &#123;</span><br><span class="line">    <span class="keyword">return</span> (*node)(atomic.LoadPointer(p))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cas</span><span class="params">(p *unsafe.Pointer, old, <span class="built_in">new</span> *node)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> atomic.CompareAndSwapPointer(p,</span><br><span class="line">        unsafe.Pointer(old), unsafe.Pointer(<span class="built_in">new</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;è°ˆåˆ°æ— é”é˜Ÿåˆ—ï¼Œå°±ä¸å¾—ä¸æ Michael å’Œ Scott åœ¨ 1996 å¹´å‘è¡¨çš„è®ºæ–‡ &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly93d3cuY3Mucm9jaGVzdGVyLmVkdS91L3Njb3R0L3BhcGVycy8xOTk2X1BPRENfcXVldWVzLnBkZg==&quot;&gt;Simple, Fast, and Practical Non-Blocking and Blocking Concurrent Queue Algorithms&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&lt;/span&gt;ï¼ŒJava ä¸­ &lt;code&gt;ConcurrentLinkedQueue&lt;/code&gt; ä¹Ÿæ˜¯åŸºäºè¯¥è®ºæ–‡çš„ç®—æ³•å®ç°ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Golang" scheme="https://blog.zcchub.xyz/categories/Golang/"/>
    
    
    <category term="å¹¶å‘" scheme="https://blog.zcchub.xyz/tags/%E5%B9%B6%E5%8F%91/"/>
    
    <category term="CAS" scheme="https://blog.zcchub.xyz/tags/CAS/"/>
    
    <category term="unsafe" scheme="https://blog.zcchub.xyz/tags/unsafe/"/>
    
  </entry>
  
  <entry>
    <title>ã€Java å¹¶å‘ã€‘volatile å…³é”®å­—åŸºæœ¬ç†è§£ä¸ä½¿ç”¨</title>
    <link href="https://blog.zcchub.xyz/java/volatile/"/>
    <id>https://blog.zcchub.xyz/java/volatile/</id>
    <published>2020-11-24T08:15:22.000Z</published>
    <updated>2022-04-02T19:22:09.111Z</updated>
    
    <content type="html"><![CDATA[<h2 id="volatile-çš„ä¸‰ä¸ªç‰¹æ€§"><a href="#volatile-çš„ä¸‰ä¸ªç‰¹æ€§" class="headerlink" title="volatile çš„ä¸‰ä¸ªç‰¹æ€§"></a>volatile çš„ä¸‰ä¸ªç‰¹æ€§</h2><ul><li>ä¿è¯å¯è§æ€§</li><li><strong>ä¸ä¿è¯åŸå­æ€§</strong></li><li>ç¦æ­¢æŒ‡ä»¤é‡æ’</li></ul><h2 id="æŒ‡ä»¤é‡æ’"><a href="#æŒ‡ä»¤é‡æ’" class="headerlink" title="æŒ‡ä»¤é‡æ’"></a>æŒ‡ä»¤é‡æ’</h2><h3 id="ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’"><a href="#ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’" class="headerlink" title="ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’"></a>ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’</h3><p>å¤„ç†å™¨ä¸ºäº†æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œå¯èƒ½ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå®ƒä¸ä¿è¯ç¨‹åºä¸­å„ä¸ªè¯­å¥çš„æ‰§è¡Œå…ˆåé¡ºåºåŒä»£ç ä¸­çš„é¡ºåºä¸€è‡´ï¼Œä½†æ˜¯å®ƒä¼šä¿è¯ç¨‹åºæœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºæ‰§è¡Œçš„ç»“æœæ˜¯ä¸€è‡´çš„ã€‚</p><span id="more"></span><p>å¯èƒ½å‘ç”Ÿé‡æ’çš„ä»£ç ï¼šï¼ˆæ„æ€å°±æ˜¯ç¬¬äºŒè¡Œä»£ç å¯èƒ½ä¼šå…ˆæ‰§è¡Œï¼Œå¬èµ·æ¥æ˜¯ä¸æ˜¯æœ‰ç‚¹åŒªå¤·æ‰€æ€ï¼‰</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">a = <span class="number">1</span>;</span><br><span class="line">b = <span class="number">2</span>;</span><br></pre></td></tr></table></figure><p>ä¸€å®šä¸ä¼šé‡æ’çš„ä»£ç ï¼ˆå› ä¸ºç¬¬ 2 è¡Œä¾èµ–ç¬¬ 1 è¡Œçš„ç»“æœï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">a = <span class="number">2</span>;</span><br><span class="line">b += a;</span><br></pre></td></tr></table></figure><h3 id="ä¸¾æ —å­"><a href="#ä¸¾æ —å­" class="headerlink" title="ä¸¾æ —å­"></a>ä¸¾æ —å­</h3><p>è§‚å¯Ÿä¸‹é¢è¿™æ®µä»£ç çš„è¿è¡Œç»“æœï¼Œå‡è®¾æ²¡æœ‰é‡æ’ï¼Œé‚£ä¹ˆè¿è¡Œç»“æœåªæœ‰å¯èƒ½æ˜¯ä»¥ä¸‹ 3 ç§ï¼š</p><ul><li>x &#x3D; 1, y &#x3D; 1ï¼ˆå…ˆæ‰§è¡Œäº† <code>a = 1</code> , <code>b = 1</code> å†æ‰§è¡Œ <code>x = b</code> å’Œ <code>y = a</code>ï¼‰</li><li>x &#x3D; 0, y &#x3D; 1ï¼ˆå…ˆæ‰§è¡Œäº† <code>a = 1</code> , <code>x = b</code> å†æ‰§è¡Œ <code>b = 1</code> å’Œ <code>y = a</code>ï¼‰</li><li>x &#x3D; 1, y &#x3D; 0ï¼ˆå…ˆæ‰§è¡Œäº† <code>b = 1</code> , <code>y = a</code> å†æ‰§è¡Œ <code>a = 1</code> å’Œ <code>x = b</code>ï¼‰</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> y;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> a;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; Integer.MAX_VALUE; i++) &#123;</span><br><span class="line">            x = y = a = b = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                a = <span class="number">1</span>;</span><br><span class="line">                x = b;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                b = <span class="number">1</span>;</span><br><span class="line">                y = a;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            t1.start();</span><br><span class="line">            t2.start();</span><br><span class="line">            t1.join();</span><br><span class="line">            t2.join();</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;i = &quot;</span> + i + <span class="string">&quot;, x = &quot;</span> + x + <span class="string">&quot;, y = &quot;</span> + y);</span><br><span class="line">            <span class="keyword">if</span> (x == <span class="number">0</span> &amp;&amp; y == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§æ¦‚åœ¨è¿è¡Œå‡ ä¸‡æ¬¡åä¼šå‡ºç°æŒ‡ä»¤é‡æ’çš„ç°è±¡ï¼Œå…ˆæ‰§è¡Œäº† <code>x = b</code> , <code>y = a</code> å†æ‰§è¡Œ <code>a = 1</code> å’Œ <code>b = 1</code>ã€‚ç»“æœå°±æ˜¯ x å’Œ y éƒ½ç­‰äº 0ã€‚</p><p><strong>è§£å†³åŠæ³•</strong>ï¼šç»™å››ä¸ªå˜é‡åŠ ä¸Š <code>volatile</code> å…³é”®å­—ï¼Œå°±ä¸ä¼šå‡ºç°é¢„æœŸä¹‹å¤–çš„é‡æ’äº†ã€‚</p><h2 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h2><p>é¦–å…ˆçœ‹ä¸€æ®µä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (flag) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        flag = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœåº”è¯¥æ˜¯ç¬¦åˆæˆ‘ä»¬é¢„æœŸçš„ï¼Œç”±äºä¸»çº¿ç¨‹ä¿®æ”¹ <code>flag = false</code> ï¼Œæ‰€ä»¥ç»ˆæ­¢äº†å¦ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ­»å¾ªç¯ã€‚</p><p>ä½†æ˜¯å¦‚æœåœ¨ <code>flag = false</code> å‰ï¼Œè®©ä¸»çº¿ç¨‹ç¡ä¸€ä¼šï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (flag) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        flag = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå‘ç°ç¨‹åºæ— æ³•åœæ­¢ï¼ˆä¾ç„¶å¤„äºæ­»å¾ªç¯ï¼‰ï¼Œè¿™å°±ä½“ç°äº†å¯è§æ€§çš„é—®é¢˜ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ä¼šä»<strong>ä¸»å­˜</strong>ä¸­æ‹·è´ä¸€ä»½ <code>flag</code> çš„å‰¯æœ¬åˆ°è‡ªå·±çš„<strong>å·¥ä½œå†…å­˜</strong>ï¼Œä¸»çº¿ç¨‹ä¸­ä¿®æ”¹ <code>flag</code> ç›¸å½“äºä¿®æ”¹äº†å‰¯æœ¬çš„å€¼ï¼Œç„¶åå†æŠŠå‰¯æœ¬çš„å€¼åˆ·åˆ°ä¸»å­˜ä¸­ã€‚ä½†æ˜¯è¿™ä¸ªæ—¶å€™å¦ä¸€ä¸ªçº¿ç¨‹å¹¶ä¸çŸ¥é“ä¸»å­˜ä¸­å‘ç”Ÿäº†ä»€ä¹ˆå˜åŠ¨ï¼Œ <code>while (flag)</code> ä½¿ç”¨çš„ä¾ç„¶æ˜¯ä¹‹å‰æ—§çš„å‰¯æœ¬ï¼Œæ‰€ä»¥å°±å¯¼è‡´äº†æ­»å¾ªç¯ï¼Œç¨‹åºæ— æ³•é€€å‡ºã€‚ï¼ˆç¬¬ä¸€ä¸ªä¾‹å­æ˜¯å› ä¸ºä¸»çº¿ç¨‹è·‘å¾—å¤ªå¿«ï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹å¼€å§‹ä»ä¸»å­˜æ‹·è´ <code>flag</code> ä¹‹å‰å°±å·²ç»æŠŠ <code>flag = false</code> åˆ·åˆ°ä¸»å­˜é‡Œäº†ï¼‰</p><p>åŠ ä¸Š <code>volatile</code> å…³é”®å­—åï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (flag) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        flag = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºæˆåŠŸé€€å‡ºã€‚åŸå› æ˜¯ä¸»çº¿ç¨‹æŠŠ <code>flag</code> åˆ·åˆ°ä¸»å­˜çš„åŒæ—¶ä¼šä½¿å…¶ä»–çº¿ç¨‹çš„ <code>flag</code> å‰¯æœ¬å¤±æ•ˆï¼Œä¸‹ä¸€æ¬¡å†åˆ¤æ–­ <code>while (flag)</code> çš„æ—¶å€™å°±ä¼šé‡æ–°ä»ä¸»å­˜è¯»å–ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;volatile-çš„ä¸‰ä¸ªç‰¹æ€§&quot;&gt;&lt;a href=&quot;#volatile-çš„ä¸‰ä¸ªç‰¹æ€§&quot; class=&quot;headerlink&quot; title=&quot;volatile çš„ä¸‰ä¸ªç‰¹æ€§&quot;&gt;&lt;/a&gt;volatile çš„ä¸‰ä¸ªç‰¹æ€§&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;ä¿è¯å¯è§æ€§&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä¸ä¿è¯åŸå­æ€§&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;ç¦æ­¢æŒ‡ä»¤é‡æ’&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;æŒ‡ä»¤é‡æ’&quot;&gt;&lt;a href=&quot;#æŒ‡ä»¤é‡æ’&quot; class=&quot;headerlink&quot; title=&quot;æŒ‡ä»¤é‡æ’&quot;&gt;&lt;/a&gt;æŒ‡ä»¤é‡æ’&lt;/h2&gt;&lt;h3 id=&quot;ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’&lt;/h3&gt;&lt;p&gt;å¤„ç†å™¨ä¸ºäº†æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œå¯èƒ½ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå®ƒä¸ä¿è¯ç¨‹åºä¸­å„ä¸ªè¯­å¥çš„æ‰§è¡Œå…ˆåé¡ºåºåŒä»£ç ä¸­çš„é¡ºåºä¸€è‡´ï¼Œä½†æ˜¯å®ƒä¼šä¿è¯ç¨‹åºæœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºæ‰§è¡Œçš„ç»“æœæ˜¯ä¸€è‡´çš„ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="https://blog.zcchub.xyz/categories/Java/"/>
    
    
    <category term="å¹¶å‘" scheme="https://blog.zcchub.xyz/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>ã€Java å¹¶å‘ã€‘é‡å…¥é”ï¼ˆReentrantLockï¼‰</title>
    <link href="https://blog.zcchub.xyz/java/reentrant-lock/"/>
    <id>https://blog.zcchub.xyz/java/reentrant-lock/</id>
    <published>2020-11-24T08:13:45.000Z</published>
    <updated>2022-04-02T19:22:09.111Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯â€œé‡å…¥â€"><a href="#ä»€ä¹ˆæ˜¯â€œé‡å…¥â€" class="headerlink" title="ä»€ä¹ˆæ˜¯â€œé‡å…¥â€"></a>ä»€ä¹ˆæ˜¯â€œé‡å…¥â€</h2><p>Re-Entrant-Lock ç¿»è¯‘æˆé‡å…¥é”ä¹Ÿæ˜¯éå¸¸è´´åˆ‡çš„ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆå«ï¼Œé‚£æ˜¯å› ä¸ºè¿™ç§é”æ˜¯å¯ä»¥åå¤è¿›å…¥çš„ã€‚å½“ç„¶ï¼Œè¿™é‡Œçš„åå¤<strong>ä»…ä»…å±€é™äºä¸€ä¸ªçº¿ç¨‹</strong>ï¼Œè§‚å¯Ÿä¸‹é¢çš„ä»£ç ï¼Œ <code>f1</code> é”ä½ <code>lock</code> ä¹‹åï¼Œ <code>f2</code> ä¾ç„¶èƒ½ç»§ç»­è·å–åˆ° <code>lock</code> å¹¶æ‰§è¡Œï¼Œå› ä¸ºå®ƒä»¬éƒ½å±äºä¸»çº¿ç¨‹ã€‚</p><span id="more"></span><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f1</span><span class="params">()</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName());</span><br><span class="line">                f2();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f2</span><span class="params">()</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Test</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">        test.f1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é‡å…¥é”-VS-synchronized"><a href="#é‡å…¥é”-VS-synchronized" class="headerlink" title="é‡å…¥é” VS synchronized"></a>é‡å…¥é” VS synchronized</h2><p>é‡å…¥é”å¯ä»¥å®Œå…¨æ›¿ä»£ <code>synchronized</code> å…³é”®å­—ã€‚åœ¨ JDK 5.0 çš„æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œé‡å…¥é”çš„æ€§èƒ½è¿œè¿œå¥½äº <code>synchronized</code> ï¼Œä½†ä» JDK 6.0 å¼€å§‹ï¼ŒJDK åœ¨ <code>synchronized</code> ä¸Šåšäº†å¤§é‡çš„ä¼˜åŒ–ï¼Œä½¿å¾—ä¸¤è€…çš„æ€§èƒ½å·®è·å¹¶ä¸å¤§ã€‚</p><p>ç”¨ä¸¤ç§æ–¹æ³•åˆ†åˆ«å®ç° <code>num++</code>ï¼š</p><h3 id="é‡å…¥é”"><a href="#é‡å…¥é”" class="headerlink" title="é‡å…¥é”"></a>é‡å…¥é”</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread[] ts = <span class="keyword">new</span> <span class="title class_">Thread</span>[<span class="number">32</span>];</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    num++;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    lock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">            ts[i] = <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">            ts[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">            ts[i].join();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread[] ts = <span class="keyword">new</span> <span class="title class_">Thread</span>[<span class="number">32</span>];</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                    num++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">            ts[i] = <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">            ts[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">            ts[i].join();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å“åº”ä¸­æ–­"><a href="#å“åº”ä¸­æ–­" class="headerlink" title="å“åº”ä¸­æ–­"></a>å“åº”ä¸­æ–­</h2><p>å¯¹äº <code>synchronized</code> æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…é”ï¼Œé‚£ä¹ˆç»“æœåªæœ‰ä¸¤ç§æƒ…å†µï¼Œè¦ä¹ˆå®ƒè·å¾—è¿™æŠŠé”ç»§ç»­æ‰§è¡Œï¼Œè¦ä¹ˆå®ƒå°±ä¿æŒç­‰å¾…ã€‚è€Œä½¿ç”¨é‡å…¥é”ï¼Œåˆ™æä¾›å¦å¤–ä¸€ç§å¯èƒ½ï¼Œé‚£å°±æ˜¯çº¿ç¨‹å¯ä»¥è¢«ä¸­æ–­ã€‚</p><p>æ¨¡æ‹Ÿä¸€ä¸ªæ­»é”çš„åœºæ™¯ï¼šä¸¤ä¸ªçº¿ç¨‹éƒ½éœ€è¦è·å– <code>lock1</code>, <code>lock2</code> ä¸¤æŠŠé”ï¼Œçº¿ç¨‹ <code>t1</code> å…ˆè·å–äº† <code>lock1</code> ï¼Œçº¿ç¨‹ <code>t2</code> å…ˆè·å–äº† <code>lock2</code> ï¼Œç„¶åå®ƒä»¬å°±å¼€å§‹æ— é™ç­‰å¾…å¯¹æ–¹è®©å‡ºé”ã€‚ä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœä¸­æ–­äº†çº¿ç¨‹ <code>t2</code> ï¼Œå¹¶ä¸”é‡Šæ”¾ <code>t2</code> å æœ‰çš„é”ï¼Œ <code>t1</code> å°±èƒ½æ­£å¸¸è¿è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">IntLock</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">lock1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">lock2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> lock;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">IntLock</span><span class="params">(<span class="type">int</span> lock)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.lock = lock;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (lock == <span class="number">1</span>) &#123;</span><br><span class="line">                    lock1.lockInterruptibly();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                        lock2.lockInterruptibly();</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;t1æˆåŠŸè·å–ä¸¤æŠŠé”&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            lock2.unlock();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;t1è¢«ä¸­æ–­&quot;</span>);</span><br><span class="line">                        Thread.currentThread().interrupt();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        lock1.unlock();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    lock2.lockInterruptibly();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                        lock1.lockInterruptibly();</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;t2æˆåŠŸè·å–ä¸¤æŠŠé”&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            lock1.unlock();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;t2è¢«ä¸­æ–­&quot;</span>);</span><br><span class="line">                        Thread.currentThread().interrupt();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        lock2.unlock();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">IntLock</span> <span class="variable">r1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntLock</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">IntLock</span> <span class="variable">r2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntLock</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r1);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r2);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        t2.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é”ç”³è¯·ç­‰å¾…é™æ—¶"><a href="#é”ç”³è¯·ç­‰å¾…é™æ—¶" class="headerlink" title="é”ç”³è¯·ç­‰å¾…é™æ—¶"></a>é”ç”³è¯·ç­‰å¾…é™æ—¶</h2><p><code>tryLock()</code> æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªè¡¨ç¤ºç­‰å¾…æ—¶é•¿ï¼Œå¦å¤–ä¸€ä¸ªè¡¨ç¤ºè®¡æ—¶å•ä½ã€‚ä¹Ÿå¯ä»¥ä¸å¸¦å‚æ•°ç›´æ¥è¿è¡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å‰çº¿ç¨‹ä¼šå°è¯•è·å¾—é”ï¼Œå¦‚æœé”å¹¶æœªè¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œåˆ™ç”³è¯·é”ä¼šæˆåŠŸï¼Œå¹¶ç«‹å³è¿”å› <code>true</code> ã€‚å¦‚æœé”è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¸ä¼šè¿›è¡Œç­‰å¾…ï¼Œè€Œæ˜¯ç«‹å³è¿”å› <code>false</code>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">target</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (lock.tryLock(<span class="number">1</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; get lock success&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">4000</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; get lock failed&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                    lock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(target);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(target);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…¬å¹³é”"><a href="#å…¬å¹³é”" class="headerlink" title="å…¬å¹³é”"></a>å…¬å¹³é”</h2><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”çš„ç”³è¯·éƒ½æ˜¯éå…¬å¹³çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿ç¨‹ 1 é¦–å…ˆè¯·æ±‚äº†é” Aï¼Œæ¥ç€çº¿ç¨‹ 2 ä¹Ÿè¯·æ±‚äº†é” Aã€‚é‚£ä¹ˆå½“é” A å¯ç”¨æ—¶ï¼Œæ˜¯çº¿ç¨‹ 1 å¯ä»¥è·å¾—é”è¿˜æ˜¯çº¿ç¨‹ 2 å¯ä»¥è·å¾—é”å‘¢ï¼Ÿè¿™æ˜¯ä¸ä¸€å®šçš„ã€‚ç³»ç»Ÿåªæ˜¯ä¼šä»è¿™ä¸ªé”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­éšæœºæŒ‘é€‰ä¸€ä¸ªã€‚å› æ­¤ä¸èƒ½ä¿è¯å…¶å…¬å¹³æ€§ã€‚è¿™å°±å¥½æ¯”ä¹°ç¥¨ä¸æ’é˜Ÿï¼Œå¤§å®¶éƒ½ä¹±å“„å“„å¾—å›´åœ¨å”®ç¥¨çª—å£å‰ï¼Œå”®ç¥¨å‘˜å¿™å¾—ç„¦å¤´çƒ‚é¢ï¼Œä¹Ÿé¡¾ä¸åŠè°å…ˆè°åï¼Œéšä¾¿æ‰¾ä¸ªäººå‡ºç¥¨å°±å®Œäº‹äº†ã€‚è€Œå…¬å¹³çš„é”ï¼Œåˆ™ä¸æ˜¯è¿™æ ·ï¼Œå®ƒä¼šæŒ‰ç…§æ—¶é—´çš„å…ˆåé¡ºåºï¼Œä¿è¯å…ˆåˆ°è€…å…ˆå¾—ï¼Œååˆ°è€…åå¾—ã€‚å…¬å¹³é”çš„ä¸€å¤§ç‰¹ç‚¹æ˜¯ï¼šå®ƒä¸ä¼šäº§ç”Ÿé¥¥é¥¿ç°è±¡ã€‚åªè¦ä½ æ’é˜Ÿï¼Œæœ€ç»ˆè¿˜æ˜¯å¯ä»¥ç­‰åˆ°èµ„æºçš„ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨ synchronized å…³é”®å­—è¿›è¡Œé”æ§åˆ¶ï¼Œé‚£ä¹ˆäº§ç”Ÿçš„é”å°±æ˜¯éå…¬å¹³çš„ã€‚è€Œé‡å…¥é”å…è®¸æˆ‘ä»¬å¯¹å…¶å…¬å¹³æ€§è¿›è¡Œè®¾ç½®ã€‚å®ƒæœ‰ä¸€ä¸ªå¦‚ä¸‹çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">(<span class="type">boolean</span> fair)</span></span><br></pre></td></tr></table></figure><p>å½“å‚æ•° fair ä¸º true æ—¶ï¼Œè¡¨ç¤ºé”æ˜¯å…¬å¹³çš„ã€‚å…¬å¹³é”çœ‹èµ·æ¥å¾ˆä¼˜ç¾ï¼Œä½†æ˜¯è¦å®ç°å…¬å¹³é”å¿…ç„¶è¦æ±‚ç³»ç»Ÿç»´æŠ¤ä¸€ä¸ª<strong>æœ‰åºé˜Ÿåˆ—</strong>ï¼Œå› æ­¤å…¬å¹³é”çš„å®ç°æˆæœ¬æ¯”è¾ƒé«˜ï¼Œæ€§èƒ½ç›¸å¯¹ä¹Ÿéå¸¸ä½ä¸‹ï¼Œå› æ­¤ï¼Œ<strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œé”æ˜¯éå…¬å¹³çš„</strong>ã€‚å¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„éœ€æ±‚ï¼Œä¹Ÿä¸éœ€è¦ä½¿ç”¨å…¬å¹³é”ã€‚å…¬å¹³é”å’Œéå…¬å¹³é”åœ¨çº¿ç¨‹è°ƒåº¦è¡¨ç°ä¸Šä¹Ÿæ˜¯éå¸¸ä¸ä¸€æ ·çš„ã€‚ä¸‹é¢çš„ä»£ç å¯ä»¥å¾ˆå¥½åœ°çªå‡ºå…¬å¹³é”çš„ç‰¹ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">fairLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">target</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">                fairLock.lock();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; è·å¾—é”&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    fairLock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(target);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(target);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        t1.interrupt();</span><br><span class="line">        t2.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªçº¿ç¨‹æ˜¯äº¤æ›¿è¿è¡Œçš„ã€‚</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">...</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æ¢æˆéå…¬å¹³é”ä¹‹åï¼Œä¼šå‘ç°è¿ç»­å¤šæ¬¡éƒ½æ˜¯åŒä¸€ä¸ªçº¿ç¨‹è·å–é”ã€‚</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">Thread-0 è·å¾—é”</span><br><span class="line">...</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">Thread-1 è·å¾—é”</span><br><span class="line">...</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯â€œé‡å…¥â€&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯â€œé‡å…¥â€&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯â€œé‡å…¥â€&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯â€œé‡å…¥â€&lt;/h2&gt;&lt;p&gt;Re-Entrant-Lock ç¿»è¯‘æˆé‡å…¥é”ä¹Ÿæ˜¯éå¸¸è´´åˆ‡çš„ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆå«ï¼Œé‚£æ˜¯å› ä¸ºè¿™ç§é”æ˜¯å¯ä»¥åå¤è¿›å…¥çš„ã€‚å½“ç„¶ï¼Œè¿™é‡Œçš„åå¤&lt;strong&gt;ä»…ä»…å±€é™äºä¸€ä¸ªçº¿ç¨‹&lt;/strong&gt;ï¼Œè§‚å¯Ÿä¸‹é¢çš„ä»£ç ï¼Œ &lt;code&gt;f1&lt;/code&gt; é”ä½ &lt;code&gt;lock&lt;/code&gt; ä¹‹åï¼Œ &lt;code&gt;f2&lt;/code&gt; ä¾ç„¶èƒ½ç»§ç»­è·å–åˆ° &lt;code&gt;lock&lt;/code&gt; å¹¶æ‰§è¡Œï¼Œå› ä¸ºå®ƒä»¬éƒ½å±äºä¸»çº¿ç¨‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="https://blog.zcchub.xyz/categories/Java/"/>
    
    
    <category term="å¹¶å‘" scheme="https://blog.zcchub.xyz/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>MySQLåŸºç¡€</title>
    <link href="https://blog.zcchub.xyz/mysql/MySql/"/>
    <id>https://blog.zcchub.xyz/mysql/MySql/</id>
    <published>2020-11-24T08:13:45.000Z</published>
    <updated>2022-04-02T19:22:09.111Z</updated>
    
    <content type="html"><![CDATA[<!-- START doctoc generated TOC please keep comment here to allow auto update --><!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --><ul><li><a href="#mysql%E5%9F%BA%E7%A1%80">MySQLåŸºç¡€</a><ul><li><a href="#%E7%B4%A2%E5%BC%95">ç´¢å¼•</a><ul><li><a href="#b-tree-%E5%8E%9F%E7%90%86">B+ Tree åŸç†</a><ul><li><a href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">æ•°æ®ç»“æ„</a></li><li><a href="#%E6%93%8D%E4%BD%9C">æ“ä½œ</a></li><li><a href="#%E4%B8%8E%E7%BA%A2%E9%BB%91%E6%A0%91%E7%9A%84%E6%AF%94%E8%BE%83">ä¸çº¢é»‘æ ‘çš„æ¯”è¾ƒ</a></li></ul></li><li><a href="#mysql-%E7%B4%A2%E5%BC%95">MySQL ç´¢å¼•</a><ul><li><a href="#b-tree-%E7%B4%A2%E5%BC%95">B+ Tree ç´¢å¼•</a></li><li><a href="#%E5%93%88%E5%B8%8C%E7%B4%A2%E5%BC%95">å“ˆå¸Œç´¢å¼•</a></li><li><a href="#%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95">å…¨æ–‡ç´¢å¼•</a></li><li><a href="#%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E7%B4%A2%E5%BC%95">ç©ºé—´æ•°æ®ç´¢å¼•</a></li></ul></li><li><a href="#%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96">ç´¢å¼•ä¼˜åŒ–</a><ul><li><a href="#%E7%8B%AC%E7%AB%8B%E7%9A%84%E5%88%97">ç‹¬ç«‹çš„åˆ—</a></li><li><a href="#%E5%A4%9A%E5%88%97%E7%B4%A2%E5%BC%95">å¤šåˆ—ç´¢å¼•</a></li><li><a href="#%E7%B4%A2%E5%BC%95%E5%88%97%E7%9A%84%E9%A1%BA%E5%BA%8F">ç´¢å¼•åˆ—çš„é¡ºåº</a></li><li><a href="#%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95">å‰ç¼€ç´¢å¼•</a></li><li><a href="#%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95">è¦†ç›–ç´¢å¼•</a></li></ul></li><li><a href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BC%98%E7%82%B9">ç´¢å¼•çš„ä¼˜ç‚¹</a><ul><li><a href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6">ç´¢å¼•çš„ä½¿ç”¨æ¡ä»¶</a></li></ul></li></ul></li><li><a href="#%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–</a><ul><li><a href="#%E4%BD%BF%E7%94%A8-explain-%E8%BF%9B%E8%A1%8C%E5%88%86%E6%9E%90">ä½¿ç”¨ Explain è¿›è¡Œåˆ†æ</a></li><li><a href="#%E4%BC%98%E5%8C%96%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE">ä¼˜åŒ–æ•°æ®è®¿é—®</a><ul><li><a href="#%E5%87%8F%E5%B0%91%E8%AF%B7%E6%B1%82%E7%9A%84%E6%95%B0%E6%8D%AE%E9%87%8F">å‡å°‘è¯·æ±‚çš„æ•°æ®é‡</a></li><li><a href="#%E5%87%8F%E5%B0%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%89%AB%E6%8F%8F%E7%9A%84%E8%A1%8C%E6%95%B0">å‡å°‘æœåŠ¡å™¨ç«¯æ‰«æçš„è¡Œæ•°</a></li></ul></li><li><a href="#%E9%87%8D%E6%9E%84%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F">é‡æ„æŸ¥è¯¢æ–¹å¼</a><ul><li><a href="#%E5%88%87%E5%88%86%E5%A4%A7%E6%9F%A5%E8%AF%A2">åˆ‡åˆ†å¤§æŸ¥è¯¢</a></li><li><a href="#%E5%88%86%E8%A7%A3%E5%A4%A7%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2">åˆ†è§£å¤§è¿æ¥æŸ¥è¯¢</a></li></ul></li></ul></li><li><a href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E">å­˜å‚¨å¼•æ“</a><ul><li><a href="#innodb">InnoDB</a></li><li><a href="#myisam">MyISAM</a></li><li><a href="#%E6%AF%94%E8%BE%83">æ¯”è¾ƒ</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">æ•°æ®ç±»å‹</a><ul><li><a href="#%E6%95%B4%E5%9E%8B">æ•´å‹</a></li><li><a href="#%E6%B5%AE%E7%82%B9%E6%95%B0">æµ®ç‚¹æ•°</a></li><li><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2">å­—ç¬¦ä¸²</a></li></ul></li><li><a href="#%E6%97%B6%E9%97%B4%E5%92%8C%E6%97%A5%E6%9C%9F">æ—¶é—´å’Œæ—¥æœŸ</a><ul><li><a href="#datetime">DATETIME</a></li><li><a href="#timestamp">TIMESTAMP</a></li></ul></li></ul></li><li><a href="#%E5%88%87%E5%88%86">åˆ‡åˆ†</a><ul><li><a href="#%E6%B0%B4%E5%B9%B3%E5%88%87%E5%88%86">æ°´å¹³åˆ‡åˆ†</a></li><li><a href="#%E5%9E%82%E7%9B%B4%E5%88%87%E5%88%86">å‚ç›´åˆ‡åˆ†</a></li><li><a href="#sharding%E7%AD%96%E7%95%A5">Shardingç­–ç•¥</a></li><li><a href="#sharding%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98">Shardingå­˜åœ¨çš„é—®é¢˜</a><ul><li><a href="#%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98">äº‹åŠ¡é—®é¢˜</a></li><li><a href="#%E8%BF%9E%E6%8E%A5">è¿æ¥</a></li><li><a href="#id%E5%94%AF%E4%B8%80%E6%80%A7">IDå”¯ä¸€æ€§</a></li></ul></li></ul></li><li><a href="#%E5%A4%8D%E5%88%B6">å¤åˆ¶</a><ul><li><a href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">ä¸»ä»å¤åˆ¶</a></li><li><a href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB">è¯»å†™åˆ†ç¦»</a></li></ul></li></ul></li></ul><!-- END doctoc generated TOC please keep comment here to allow auto update --><h1 id="MySQLåŸºç¡€"><a href="#MySQLåŸºç¡€" class="headerlink" title="MySQLåŸºç¡€"></a>MySQLåŸºç¡€</h1><h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><hr><h3 id="B-Tree-åŸç†"><a href="#B-Tree-åŸç†" class="headerlink" title="B+ Tree åŸç†"></a>B+ Tree åŸç†</h3><hr><h4 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h4><hr><p>B Tree æŒ‡çš„æ˜¯ Balance Tree, ä¹Ÿå°±æ˜¯å¹³è¡¡æ ‘ã€‚å¹³è¡¡æ ‘æ˜¯ä¸€é¢—æŸ¥æ‰¾æ ‘ï¼Œå¹¶ä¸”æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ä½äºåŒä¸€å±‚ã€‚<br>B+ Tree æ˜¯åŸºäº B Tree å’Œå¶å­èŠ‚ç‚¹é¡ºåºè®¿é—®æŒ‡é’ˆè¿›è¡Œå®ç°ï¼Œå®ƒå…·æœ‰B Tree çš„å¹³è¡¡æ€§ï¼Œå¹¶ä¸”é€šè¿‡é¡ºåºè®¿é—®æŒ‡é’ˆæ¥æé«˜åŒºé—´æŸ¥è¯¢çš„æ€§èƒ½ã€‚<br>åœ¨ B+ Tree ä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¸­çš„ key ä»å·¦åˆ°å³éé€’å‡æ’åˆ—ï¼Œå¦‚æœæŸä¸ªæŒ‡é’ˆçš„å·¦å³ç›¸é‚» key åˆ†åˆ«æ˜¯ $key_i$ å’Œ $key_i+1$ï¼Œä¸”ä¸ä¸º null, åˆ™è¯¥æŒ‡é’ˆæŒ‡å‘èŠ‚ç‚¹çš„æ‰€æœ‰ key å¤§äºç­‰äº $key_i$ ä¸”å°äºç­‰äº $key_i+1$ã€‚<br><img data-src="/../../images/mysql1.png" alt="PNG" loading="lazy"></p><hr><h4 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h4><hr><p>è¿›è¡ŒæŸ¥æ‰¾æ“ä½œæ—¶ï¼Œé¦–å…ˆåœ¨æ ¹èŠ‚ç‚¹è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°ä¸€ä¸ª key æ‰€åœ¨çš„æŒ‡é’ˆï¼Œç„¶åé€’å½’åœ°åœ¨æŒ‡é’ˆæ‰€æŒ‡å‘çš„èŠ‚ç‚¹è¿›è¡ŒæŸ¥æ‰¾ã€‚ç›´åˆ°æŸ¥æ‰¾åˆ°å¶å­èŠ‚ç‚¹ï¼Œç„¶ååœ¨å¶å­èŠ‚ç‚¹ä¸Šè¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾å‡º key æ‰€å¯¹åº”çš„ data ã€‚</p><p>æ’å…¥åˆ é™¤æ“ä½œä¼šç ´åå¹³è¡¡æ ‘çš„å¹³è¡¡æ€§ï¼Œå› æ­¤åœ¨è¿›è¡Œæ’å…¥åˆ é™¤æ“ä½œä¹‹åï¼Œéœ€è¦å¯¹æ ‘è¿›è¡Œåˆ†è£‚ã€åˆå¹¶ã€æ—‹è½¬ç­‰æ“ä½œæ¥ç»´æŠ¤å¹³è¡¡æ€§ã€‚</p><hr><h4 id="ä¸çº¢é»‘æ ‘çš„æ¯”è¾ƒ"><a href="#ä¸çº¢é»‘æ ‘çš„æ¯”è¾ƒ" class="headerlink" title="ä¸çº¢é»‘æ ‘çš„æ¯”è¾ƒ"></a>ä¸çº¢é»‘æ ‘çš„æ¯”è¾ƒ</h4><hr><p>çº¢é»‘æ ‘ç­‰å¹³è¡¡æ ‘ä¹Ÿå¯ä»¥ç”¨æ¥å®ç°ç´¢å¼•ï¼Œä½†æ˜¯æ–‡ä»¶ç³»ç»ŸåŠæ•°æ®åº“ç³»ç»Ÿæ™®éé‡‡ç”¨ B+ Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œè¿™æ˜¯å› ä¸ºä½¿ç”¨ B+ æ ‘è®¿é—®ç£ç›˜æ•°æ®æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚<br>ï¼ˆä¸€ï¼‰B+ æ ‘æœ‰æ›´ä½çš„æ ‘é«˜<br>å¹³è¡¡æ ‘çš„æ ‘é«˜ $O(h)&#x3D;O(log dN)$ï¼Œå…¶ä¸­ d ä¸ºæ¯ä¸ªèŠ‚ç‚¹çš„å‡ºåº¦ã€‚çº¢é»‘æ ‘çš„å‡ºåº¦ä¸º 2ï¼Œè€Œ B+ Tree çš„å‡ºåº¦ä¸€èˆ¬éƒ½éå¸¸å¤§ï¼Œæ‰€ä»¥çº¢é»‘æ ‘çš„æ ‘é«˜ h å¾ˆæ˜æ˜¾æ¯” B+ Tree å¤§éå¸¸å¤šã€‚<br>ï¼ˆäºŒï¼‰ç£ç›˜è®¿é—®åŸç†<br>æ“ä½œç³»ç»Ÿä¸€èˆ¬å°†å†…å­˜å’Œç£ç›˜åˆ†å‰²æˆå›ºå®šå¤§å°çš„å—ï¼Œæ¯ä¸€å—ç§°ä¸ºä¸€é¡µï¼Œå†…å­˜ä¸ç£ç›˜ä»¥é¡µä¸ºå•ä½äº¤æ¢æ•°æ®ã€‚æ•°æ®åº“ç³»ç»Ÿå°†ç´¢å¼•çš„ä¸€ä¸ªèŠ‚ç‚¹çš„å¤§å°è®¾ç½®ä¸ºé¡µçš„å¤§å°ï¼Œä½¿å¾—ä¸€æ¬¡ I&#x2F;O å°±èƒ½å®Œå…¨è½½å…¥ä¸€ä¸ªèŠ‚ç‚¹ã€‚<br>å¦‚æœæ•°æ®ä¸åœ¨åŒä¸€ä¸ªç£ç›˜å—ä¸Šï¼Œé‚£ä¹ˆé€šå¸¸éœ€è¦ç§»åŠ¨åˆ¶åŠ¨æ‰‹è‡‚è¿›è¡Œå¯»é“ï¼Œè€Œåˆ¶åŠ¨æ‰‹è‡‚å› ä¸ºå…¶ç‰©ç†ç»“æ„å¯¼è‡´äº†ç§»åŠ¨æ•ˆç‡ä½ä¸‹ï¼Œä»è€Œå¢åŠ ç£ç›˜æ•°æ®è¯»å–æ—¶é—´ ã€‚ B+ æ ‘ç›¸å¯¹äºçº¢é»‘æ ‘æœ‰æ›´ä½çš„æ ‘é«˜ï¼Œè¿›è¡Œå¯»é“çš„æ¬¡æ•°ä¸æ ‘é«˜æˆæ­£æ¯”ï¼Œåœ¨åŒä¸€ä¸ªç£ç›˜å—ä¸Šè¿›è¡Œè®¿é—®åªéœ€è¦å¾ˆçŸ­çš„ç£ç›˜æ—‹è½¬æ—¶é—´ï¼Œæ‰€ä»¥ B+ æ ‘æ›´é€‚åˆç£ç›˜æ•°æ®çš„è¯»å–ã€‚<br>ï¼ˆä¸‰ï¼‰ç£ç›˜é¢„è¯»ç‰¹æ€§<br>ä¸ºäº†å‡å°‘ç£ç›˜ I&#x2F;O æ“ä½œï¼Œç£ç›˜å¾€å¾€ä¸æ˜¯ä¸¥æ ¼æŒ‰éœ€è¯»å–ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½ä¼šé¢„è¯»ã€‚é¢„è¯»è¿‡ç¨‹ä¸­ï¼Œç£ç›˜è¿›è¡Œé¡ºåºè¯»å–ï¼Œé¡ºåºè¯»å–ä¸éœ€è¦è¿›è¡Œç£ç›˜å¯»é“ï¼Œå¹¶ä¸”åªéœ€è¦å¾ˆçŸ­çš„ç£ç›˜æ—‹è½¬æ—¶é—´ï¼Œé€Ÿåº¦ä¼šéå¸¸å¿«ã€‚å¹¶ä¸”å¯ä»¥åˆ©ç”¨é¢„è¯»ç‰¹æ€§ï¼Œç›¸é‚»çš„èŠ‚ç‚¹ä¹Ÿèƒ½å¤Ÿè¢«é¢„å…ˆè½½å…¥ã€‚</p><hr><h3 id="MySQL-ç´¢å¼•"><a href="#MySQL-ç´¢å¼•" class="headerlink" title="MySQL ç´¢å¼•"></a>MySQL ç´¢å¼•</h3><hr><p>ç´¢å¼•æ˜¯åœ¨å­˜å‚¨å¼•æ“å±‚å®ç°çš„ï¼Œè€Œä¸æ˜¯åœ¨æœåŠ¡å™¨å±‚å®ç°çš„ï¼Œæ‰€ä»¥ä¸åŒå­˜å‚¨å¼•æ“å…·æœ‰ä¸åŒçš„ç´¢å¼•ç±»å‹å’Œå®ç°ã€‚</p><hr><h4 id="B-Tree-ç´¢å¼•"><a href="#B-Tree-ç´¢å¼•" class="headerlink" title="B+ Tree ç´¢å¼•"></a>B+ Tree ç´¢å¼•</h4><hr><p>æ˜¯å¤§å¤šæ•° MySQL å­˜å‚¨å¼•æ“çš„é»˜è®¤ç´¢å¼•ç±»å‹ã€‚</p><pre><code>â— å› ä¸ºä¸å†éœ€è¦è¿›è¡Œå…¨è¡¨æ‰«æï¼Œåªéœ€è¦å¯¹æ ‘è¿›è¡Œæœç´¢å³å¯ï¼Œæ‰€ä»¥æŸ¥æ‰¾é€Ÿåº¦å¿«å¾ˆå¤šã€‚â— å› ä¸º B+ Tree çš„æœ‰åºæ€§ï¼Œæ‰€ä»¥é™¤äº†ç”¨äºæŸ¥æ‰¾ï¼Œè¿˜å¯ä»¥ç”¨äºæ’åºå’Œåˆ†ç»„ã€‚â— å¯ä»¥æŒ‡å®šå¤šä¸ªåˆ—ä½œä¸ºç´¢å¼•åˆ—ï¼Œå¤šä¸ªç´¢å¼•åˆ—å…±åŒç»„æˆé”®ã€‚</code></pre><p>é€‚ç”¨äºå…¨é”®å€¼ã€é”®å€¼èŒƒå›´å’Œé”®å‰ç¼€æŸ¥æ‰¾ï¼Œå…¶ä¸­é”®å‰ç¼€æŸ¥æ‰¾åªé€‚ç”¨äºæœ€å·¦å‰ç¼€æŸ¥æ‰¾ã€‚å¦‚æœä¸æ˜¯æŒ‰ç…§ç´¢å¼•åˆ—çš„é¡ºåºè¿›è¡ŒæŸ¥æ‰¾ï¼Œåˆ™æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚</p><p>InnoDB çš„ B+Tree ç´¢å¼•åˆ†ä¸ºä¸»ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•ã€‚ä¸»ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ data åŸŸè®°å½•ç€å®Œæ•´çš„æ•°æ®è®°å½•ï¼Œè¿™ç§ç´¢å¼•æ–¹å¼è¢«ç§°ä¸ºèšç°‡ç´¢å¼•ã€‚å› ä¸ºæ— æ³•æŠŠæ•°æ®è¡Œå­˜æ”¾åœ¨ä¸¤ä¸ªä¸åŒçš„åœ°æ–¹ï¼Œæ‰€ä»¥ä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•ã€‚<br><img data-src="/../../images/mysql2.png" alt="PNG" loading="lazy"><br>è¾…åŠ©ç´¢å¼•çš„å¶å­èŠ‚ç‚¹çš„ data åŸŸè®°å½•ç€ä¸»é”®çš„å€¼ï¼Œå› æ­¤åœ¨ä½¿ç”¨è¾…åŠ©ç´¢å¼•è¿›è¡ŒæŸ¥æ‰¾æ—¶ï¼Œéœ€è¦å…ˆæŸ¥æ‰¾åˆ°ä¸»é”®å€¼ï¼Œç„¶åå†åˆ°ä¸»ç´¢å¼•ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚</p><hr><h4 id="å“ˆå¸Œç´¢å¼•"><a href="#å“ˆå¸Œç´¢å¼•" class="headerlink" title="å“ˆå¸Œç´¢å¼•"></a>å“ˆå¸Œç´¢å¼•</h4><hr><p>å“ˆå¸Œç´¢å¼•èƒ½ä»¥ O(1) æ—¶é—´è¿›è¡ŒæŸ¥æ‰¾ï¼Œä½†æ˜¯å¤±å»äº†æœ‰åºæ€§ï¼š</p><pre><code>â— æ— æ³•ç”¨äºæ’åºä¸åˆ†ç»„ï¼›â— åªæ”¯æŒç²¾ç¡®æŸ¥æ‰¾ï¼Œæ— æ³•ç”¨äºéƒ¨åˆ†æŸ¥æ‰¾å’ŒèŒƒå›´æŸ¥æ‰¾ã€‚</code></pre><p>InnoDB å­˜å‚¨å¼•æ“æœ‰ä¸€ä¸ªç‰¹æ®Šçš„åŠŸèƒ½å« â€œè‡ªé€‚åº”å“ˆå¸Œç´¢å¼•â€ ï¼Œå½“æŸä¸ªç´¢å¼•å€¼è¢«ä½¿ç”¨çš„éå¸¸é¢‘ç¹æ—¶ï¼Œä¼šåœ¨ B+Tree ç´¢å¼•ä¹‹ä¸Šå†åˆ›å»ºä¸€ä¸ªå“ˆå¸Œç´¢å¼•ï¼Œè¿™æ ·å°±è®© B+Tree ç´¢å¼•å…·æœ‰å“ˆå¸Œç´¢å¼•çš„ä¸€äº›ä¼˜ç‚¹ï¼Œæ¯”å¦‚å¿«é€Ÿçš„å“ˆå¸ŒæŸ¥æ‰¾ã€‚</p><hr><h4 id="å…¨æ–‡ç´¢å¼•"><a href="#å…¨æ–‡ç´¢å¼•" class="headerlink" title="å…¨æ–‡ç´¢å¼•"></a>å…¨æ–‡ç´¢å¼•</h4><hr><p>MyISAM å­˜å‚¨å¼•æ“æ”¯æŒå…¨æ–‡ç´¢å¼•ï¼Œç”¨äºæŸ¥æ‰¾æ–‡æœ¬ä¸­çš„å…³é”®è¯ï¼Œè€Œä¸æ˜¯ç›´æ¥æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰ã€‚</p><p>æŸ¥æ‰¾æ¡ä»¶ä½¿ç”¨ MATCH AGAINST ï¼Œ è€Œä¸æ˜¯æ™®é€šçš„ WHERE ã€‚<br>å…¨æ–‡ç´¢å¼•ä½¿ç”¨å€’æ’ç´¢å¼•å®ç°ï¼Œå®ƒè®°å½•ç€å…³é”®è¯åˆ°å…¶æ‰€åœ¨æ–‡æ¡£çš„æ˜ å°„ã€‚<br>InnoDB å­˜å‚¨å¼•æ“åœ¨ MySQL 5.6.4 ç‰ˆæœ¬ä¸­ä¹Ÿå¼€å§‹æ”¯æŒå…¨æ–‡ç´¢å¼•ã€‚</p><hr><h4 id="ç©ºé—´æ•°æ®ç´¢å¼•"><a href="#ç©ºé—´æ•°æ®ç´¢å¼•" class="headerlink" title="ç©ºé—´æ•°æ®ç´¢å¼•"></a>ç©ºé—´æ•°æ®ç´¢å¼•</h4><hr><p>MyISAM å­˜å‚¨å¼•æ“æ”¯æŒç©ºé—´æ•°æ®ç´¢å¼•ï¼ˆR-Treeï¼‰ï¼Œå¯ä»¥ç”¨äºåœ°ç†æ•°æ®å­˜å‚¨ã€‚ç©ºé—´æ•°æ®ç´¢å¼•ä¼šä»æ‰€æœ‰ç»´åº¦æ¥ç´¢å¼•æ•°æ®ï¼Œå¯ä»¥æœ‰æ•ˆåœ°ä½¿ç”¨ä»»æ„ç»´åº¦æ¥è¿›è¡Œç»„åˆæŸ¥è¯¢ã€‚</p><p>å¿…é¡»ä½¿ç”¨ GIS ç›¸å…³çš„å‡½æ•°æ¥ç»´æŠ¤æ•°æ®ã€‚</p><hr><h3 id="ç´¢å¼•ä¼˜åŒ–"><a href="#ç´¢å¼•ä¼˜åŒ–" class="headerlink" title="ç´¢å¼•ä¼˜åŒ–"></a>ç´¢å¼•ä¼˜åŒ–</h3><hr><h4 id="ç‹¬ç«‹çš„åˆ—"><a href="#ç‹¬ç«‹çš„åˆ—" class="headerlink" title="ç‹¬ç«‹çš„åˆ—"></a>ç‹¬ç«‹çš„åˆ—</h4><hr><p>åœ¨è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œç´¢å¼•åˆ—ä¸èƒ½æ˜¯è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸èƒ½æ˜¯å‡½æ•°çš„å‚æ•°ï¼Œå¦åˆ™æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚<br>ä¾‹å¦‚ä¸‹é¢çš„æŸ¥è¯¢ä¸èƒ½ä½¿ç”¨ actor_id åˆ—çš„ç´¢å¼•ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> actor_id <span class="keyword">FROM</span> sakila.actor <span class="keyword">WHERE</span> actor_id <span class="operator">+</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure><h4 id="å¤šåˆ—ç´¢å¼•"><a href="#å¤šåˆ—ç´¢å¼•" class="headerlink" title="å¤šåˆ—ç´¢å¼•"></a>å¤šåˆ—ç´¢å¼•</h4><hr><p>åœ¨éœ€è¦ä½¿ç”¨å¤šä¸ªåˆ—ä½œä¸ºæ¡ä»¶è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œä½¿ç”¨å¤šåˆ—ç´¢å¼•æ¯”ä½¿ç”¨å¤šä¸ªå•åˆ—ç´¢å¼•æ€§èƒ½æ›´å¥½ã€‚ä¾‹å¦‚ä¸‹é¢çš„è¯­å¥ä¸­ï¼Œæœ€å¥½æŠŠ actor_id å’Œ film_id è®¾ç½®ä¸ºå¤šåˆ—ç´¢å¼•ã€‚</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> film_id, actor_ id <span class="keyword">FROM</span> sakila.film_actor</span><br><span class="line"><span class="keyword">WHERE</span> actor_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">AND</span> film_id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h4 id="ç´¢å¼•åˆ—çš„é¡ºåº"><a href="#ç´¢å¼•åˆ—çš„é¡ºåº" class="headerlink" title="ç´¢å¼•åˆ—çš„é¡ºåº"></a>ç´¢å¼•åˆ—çš„é¡ºåº</h4><hr><p>è®©é€‰æ‹©æ€§æœ€å¼ºçš„ç´¢å¼•åˆ—æ”¾åœ¨å‰é¢ã€‚</p><p>ç´¢å¼•çš„é€‰æ‹©æ€§æ˜¯æŒ‡ï¼šä¸é‡å¤çš„ç´¢å¼•å€¼å’Œè®°å½•æ€»æ•°çš„æ¯”å€¼ã€‚æœ€å¤§å€¼ä¸º 1ï¼Œæ­¤æ—¶æ¯ä¸ªè®°å½•éƒ½æœ‰å”¯ä¸€çš„ç´¢å¼•ä¸å…¶å¯¹åº”ã€‚é€‰æ‹©æ€§è¶Šé«˜ï¼Œæ¯ä¸ªè®°å½•çš„åŒºåˆ†åº¦è¶Šé«˜ï¼ŒæŸ¥è¯¢æ•ˆç‡ä¹Ÿè¶Šé«˜ã€‚</p><p>ä¾‹å¦‚ä¸‹é¢æ˜¾ç¤ºçš„ç»“æœä¸­ customer_id çš„é€‰æ‹©æ€§æ¯” staff_id æ›´é«˜ï¼Œå› æ­¤æœ€å¥½æŠŠ customer_id åˆ—æ”¾åœ¨å¤šåˆ—ç´¢å¼•çš„å‰é¢ã€‚</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> staff_id)<span class="operator">/</span><span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> staff_id_selectivity,</span><br><span class="line"><span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> customer_id)<span class="operator">/</span><span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> customer_id_selectivity,</span><br><span class="line"><span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> payment;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">staff_id_selectivity: 0.0001</span><br><span class="line">customer_id_selectivity: 0.0373</span><br><span class="line">               COUNT(*): 16049</span><br></pre></td></tr></table></figure><hr><h4 id="å‰ç¼€ç´¢å¼•"><a href="#å‰ç¼€ç´¢å¼•" class="headerlink" title="å‰ç¼€ç´¢å¼•"></a>å‰ç¼€ç´¢å¼•</h4><hr><p>å¯¹äºBLOBã€TEXTå’Œ VARCHAR ç±»å‹çš„åˆ—ï¼Œå¿…é¡»ä½¿ç”¨å‰ç¼€ç´¢å¼•ï¼Œåªç´¢å¼•å¼€å§‹çš„éƒ¨åˆ†å­—ç¬¦ä¸²ã€‚</p><p>å‰ç¼€é•¿åº¦çš„é€‰å–éœ€è¦æ ¹æ®ç´¢å¼•é€‰æ‹©æ€§æ¥ç¡®å®šã€‚</p><hr><h4 id="è¦†ç›–ç´¢å¼•"><a href="#è¦†ç›–ç´¢å¼•" class="headerlink" title="è¦†ç›–ç´¢å¼•"></a>è¦†ç›–ç´¢å¼•</h4><hr><p>ç´¢å¼•åŒ…å«æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µçš„å€¼ã€‚</p><p>å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p><pre><code>â— ç´¢å¼•é€šå¸¸è¿œå°äºæ•°æ®è¡Œçš„å¤§å°ï¼Œåªè¯»å–ç´¢å¼•èƒ½å¤§å¤§å‡å°‘æ•°æ®è®¿é—®é‡ã€‚â— ä¸€äº›å­˜å‚¨å¼•æ“(ä¾‹å¦‚ MyISAM) åœ¨å†…å­˜ä¸­åªèƒ½ç¼“å­˜ç´¢å¼•ï¼Œè€Œæ•°æ®ä¾èµ–äºæ“ä½œç³»ç»Ÿæ¥ç¼“å­˜ã€‚å› æ­¤ï¼Œåªè®¿é—®ç´¢å¼•å¯ä»¥ä¸ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨(é€šå¸¸æ¯”è¾ƒè´¹æ—¶)ã€‚â— å¯¹äºInnoDBå¼•æ“ï¼Œè‹¥è¾…åŠ©ç´¢å¼•èƒ½å¤Ÿè¦†ç›–æŸ¥è¯¢ï¼Œåˆ™æ— éœ€è®¿é—®ä¸»ç´¢å¼•ã€‚</code></pre><hr><h3 id="ç´¢å¼•çš„ä¼˜ç‚¹"><a href="#ç´¢å¼•çš„ä¼˜ç‚¹" class="headerlink" title="ç´¢å¼•çš„ä¼˜ç‚¹"></a>ç´¢å¼•çš„ä¼˜ç‚¹</h3><hr><pre><code>â— å¤§å¤§å‡å°‘äº†æœåŠ¡å™¨éœ€è¦æ‰«æçš„æ•°æ®è¡Œã€‚â— å¸®åŠ©æœåŠ¡å™¨é¿å…è¿›è¡Œæ’åºå’Œåˆ†ç»„ ï¼Œä»¥åŠé¿å…åˆ›å»ºä¸´æ—¶è¡¨ï¼ˆB+ Treeç´¢å¼•æ˜¯æœ‰åºçš„,  å¯ä»¥ç”¨äºORDER BYå’ŒGROUP BYæ“ä½œã€‚ä¸´æ—¶è¡¨ä¸»è¦æ˜¯åœ¨æ’åºå’Œåˆ†ç»„çš„è¿‡ç¨‹ä¸­åˆ›å»ºçš„ï¼Œ  ä¸éœ€è¦æ’åºå’Œåˆ†ç»„ï¼Œä¹Ÿå°±ä¸éœ€è¦åˆ›å»ºä¸´æ—¶è¡¨ï¼‰ã€‚â— å°†éšæœº I/Oå˜ä¸ºé¡ºåº I/O ï¼ˆB+ Treeç´¢å¼•æ˜¯æœ‰åºçš„ï¼Œä¼šå°†ç›¸é‚»åœ°æ•°æ®éƒ½å­˜å‚¨åœ¨ä¸€èµ·ï¼‰ã€‚</code></pre><hr><h4 id="ç´¢å¼•çš„ä½¿ç”¨æ¡ä»¶"><a href="#ç´¢å¼•çš„ä½¿ç”¨æ¡ä»¶" class="headerlink" title="ç´¢å¼•çš„ä½¿ç”¨æ¡ä»¶"></a>ç´¢å¼•çš„ä½¿ç”¨æ¡ä»¶</h4><hr><pre><code>â— å¯¹äºéå¸¸å°çš„è¡¨ã€å¤§éƒ¨åˆ†æƒ…å†µä¸‹ç®€å•çš„å…¨è¡¨æ‰«ææ¯”å»ºç«‹ç´¢å¼•æ›´é«˜æ•ˆï¼›â— å¯¹äºä¸­åˆ°å¤§å°çš„è¡¨ï¼Œæ‰€ä»¥å°±éå¸¸æœ‰æ•ˆï¼›â— ä½†æ˜¯å¯¹äºç‰¹å¤§çš„è¡¨ï¼Œå»ºç«‹å’Œç»´æŠ¤ç´¢å¼•çš„ä»£ä»·å°†ä¼šéšä¹‹å¢é•¿ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦ç”¨åˆ°ä¸€ç§æŠ€æœ¯å¯ä»¥åŒºåˆ†å‡ºéœ€è¦æŸ¥è¯¢çš„ä¸€ç»„æ•°æ®ï¼Œ  è€Œä¸æ˜¯ä¸€æ¡ä¸€æ¡è®°å½•çš„åŒ¹é…ï¼Œä¾‹å¦‚å¯ä»¥ä½¿ç”¨åˆ†åŒºæŠ€æœ¯ã€‚</code></pre><hr><h2 id="æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–"><a href="#æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–"></a>æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–</h2><hr><h3 id="ä½¿ç”¨-Explain-è¿›è¡Œåˆ†æ"><a href="#ä½¿ç”¨-Explain-è¿›è¡Œåˆ†æ" class="headerlink" title="ä½¿ç”¨ Explain è¿›è¡Œåˆ†æ"></a>ä½¿ç”¨ Explain è¿›è¡Œåˆ†æ</h3><hr><p>Explain ç”¨æ¥åˆ†æ SELECTæŸ¥è¯¢è¯­å¥ï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡åˆ†æExplainç»“æœæ¥ä¼˜åŒ–æŸ¥è¯¢è¯­å¥ã€‚<br>æ¯”è¾ƒé‡è¦çš„å­—æ®µæœ‰ï¼š</p><pre><code>â— select_type:æŸ¥è¯¢ç±»å‹ï¼Œæœ‰ç®€å•æŸ¥è¯¢ã€è”åˆæŸ¥è¯¢ã€å­æŸ¥è¯¢ç­‰â— keyï¼šä½¿ç”¨çš„ç´¢å¼•â— rowsï¼šæ‰«æçš„è¡Œæ•°</code></pre><hr><h3 id="ä¼˜åŒ–æ•°æ®è®¿é—®"><a href="#ä¼˜åŒ–æ•°æ®è®¿é—®" class="headerlink" title="ä¼˜åŒ–æ•°æ®è®¿é—®"></a>ä¼˜åŒ–æ•°æ®è®¿é—®</h3><hr><h4 id="å‡å°‘è¯·æ±‚çš„æ•°æ®é‡"><a href="#å‡å°‘è¯·æ±‚çš„æ•°æ®é‡" class="headerlink" title="å‡å°‘è¯·æ±‚çš„æ•°æ®é‡"></a>å‡å°‘è¯·æ±‚çš„æ•°æ®é‡</h4><hr><pre><code>â— åªè¿”å›å¿…è¦çš„åˆ—ï¼šæœ€å¥½ä¸è¦ä½¿ç”¨SELECT*è¯­å¥ã€‚â— åªè¿”å›å¿…è¦çš„è¡Œï¼šä½¿ç”¨LIMITè¯­å¥æ¥é™åˆ¶è¿”å›çš„æ•°æ®ã€‚â— ç¼“å­˜é‡å¤æŸ¥è¯¢çš„æ•°æ®ï¼šä½¿ç”¨ç¼“å­˜å¯ä»¥é¿å…åœ¨æ•°æ®åº“ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œç‰¹åˆ«åœ¨è¦æŸ¥è¯¢çš„æ•°æ®ç»å¸¸è¢«é‡å¤æŸ¥è¯¢æ—¶ï¼Œç¼“å­˜å¸¦æ¥çš„æŸ¥è¯¢æ€§èƒ½æå‡å°†ä¼šæ˜¯éå¸¸æ˜æ˜¾çš„ã€‚</code></pre><hr><h4 id="å‡å°‘æœåŠ¡å™¨ç«¯æ‰«æçš„è¡Œæ•°"><a href="#å‡å°‘æœåŠ¡å™¨ç«¯æ‰«æçš„è¡Œæ•°" class="headerlink" title="å‡å°‘æœåŠ¡å™¨ç«¯æ‰«æçš„è¡Œæ•°"></a>å‡å°‘æœåŠ¡å™¨ç«¯æ‰«æçš„è¡Œæ•°</h4><hr><p>æœ€æœ‰æ•ˆçš„æ–¹å¼æ˜¯ä½¿ç”¨ç´¢å¼•æ¥è¦†ç›–æŸ¥è¯¢ã€‚</p><hr><h3 id="é‡æ„æŸ¥è¯¢æ–¹å¼"><a href="#é‡æ„æŸ¥è¯¢æ–¹å¼" class="headerlink" title="é‡æ„æŸ¥è¯¢æ–¹å¼"></a>é‡æ„æŸ¥è¯¢æ–¹å¼</h3><hr><h4 id="åˆ‡åˆ†å¤§æŸ¥è¯¢"><a href="#åˆ‡åˆ†å¤§æŸ¥è¯¢" class="headerlink" title="åˆ‡åˆ†å¤§æŸ¥è¯¢"></a>åˆ‡åˆ†å¤§æŸ¥è¯¢</h4><hr><p>ä¸€ä¸ªå¤§æŸ¥è¯¢å¦‚æœä¸€æ¬¡æ€§æ‰§è¡Œçš„è¯ï¼Œå¯èƒ½ä¸€æ¬¡é”ä½å¾ˆå¤šæ•°æ®ã€å æ»¡æ•´ä¸ªäº‹åŠ¡æ—¥å¿—ã€è€—å°½ç³»ç»Ÿèµ„æºã€é˜»å¡å¾ˆå¤šå°çš„ä½†æ˜¯é‡è¦çš„æŸ¥è¯¢ã€‚</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> messages <span class="keyword">WHERE</span> <span class="keyword">create</span> <span class="operator">&lt;</span> DATE_SUB(NOW(), <span class="type">INTERVAL</span> <span class="number">3</span> <span class="keyword">MONTH</span>);</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">rows_affected = <span class="number">0</span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    rows_affected = <span class="title function_ invoke__">do_query</span>(</span><br><span class="line">    <span class="string">&quot;DELETE FROM messages WHERE create  &lt; DATE_SUB(NOW(), INTERVAL 3 MONTH) LIMIT 10000&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">while</span> rows_affected &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure><hr><h4 id="åˆ†è§£å¤§è¿æ¥æŸ¥è¯¢"><a href="#åˆ†è§£å¤§è¿æ¥æŸ¥è¯¢" class="headerlink" title="åˆ†è§£å¤§è¿æ¥æŸ¥è¯¢"></a>åˆ†è§£å¤§è¿æ¥æŸ¥è¯¢</h4><hr><p>å°†ä¸€ä¸ªå¤§è¿æ¥æŸ¥è¯¢åˆ†è§£æˆå¯¹æ¯ä¸€ä¸ªè¡¨è¿›è¡Œä¸€æ¬¡å•è¡¨æŸ¥è¯¢ï¼Œç„¶ååœ¨åº”ç”¨ç¨‹åºä¸­è¿›è¡Œå…³è”ï¼Œè¿™æ ·åšçš„å¥½å¤„æœ‰ï¼š<br>    â— è®©ç¼“å­˜æ›´é«˜æ•ˆï¼Œå¯¹äºè¿æ¥æŸ¥è¯¢ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªè¡¨å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆæ•´ä¸ªæŸ¥è¯¢ç¼“å­˜å°±æ— æ³•ä½¿ç”¨ã€‚è€Œåˆ†è§£åçš„å¤šä¸ªæŸ¥è¯¢ï¼Œå³æ˜¯å…¶ä¸­ä¸€ä¸ªè¡¨å‘ç”Ÿå˜åŒ–ï¼Œå¯¹å…¶ä»–è¡¨çš„æŸ¥è¯¢ç¼“å­˜ä¾æ—§å¯ä»¥ä½¿ç”¨ã€‚<br>    â— åˆ†è§£æˆå¤šä¸ªå•è¡¨æŸ¥è¯¢ï¼Œè¿™äº›å•è¡¨æŸ¥è¯¢çš„ç¼“å­˜ç»“æœæ›´å¯èƒ½è¢«å…¶ä»–æŸ¥è¯¢ä½¿ç”¨åˆ°ï¼Œä»è€Œå‡å°‘å†—ä½™è®°å½•çš„æŸ¥è¯¢ã€‚<br>    â— å‡å°‘é”ç«äº‰ï¼›<br>    â— åœ¨åº”ç”¨å±‚è¿›è¡Œè¿æ¥ï¼Œå¯ä»¥æ›´å®¹æ˜“å¯¹æ•°æ®åº“è¿›è¡Œæ‹†åˆ†ï¼Œä»è€Œæ›´å®¹æ˜“åšåˆ°é«˜æ€§èƒ½å’Œå¯ä¼¸ç¼©ã€‚<br>    â— æŸ¥è¯¢æœ¬èº«æ•ˆç‡ä¹Ÿå¯èƒ½ä¼šæœ‰æ‰€æå‡ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œä½¿ç”¨IN()ä»£æ›¿è¿æ¥æŸ¥è¯¢ï¼Œå¯ä»¥è®©MySQLæŒ‰ç…§IDé¡ºåºè¿›è¡ŒæŸ¥è¯¢ï¼Œè¿™å¯èƒ½æ¯”éšæœºçš„è¿æ¥è¦æ›´é«˜æ•ˆã€‚</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tag</span><br><span class="line"><span class="keyword">JOIN</span> tag_post <span class="keyword">ON</span> tag_post.tag_id<span class="operator">=</span>tag.id</span><br><span class="line"><span class="keyword">JOIN</span> post <span class="keyword">ON</span> tag_post.post_id<span class="operator">=</span>post.id</span><br><span class="line"><span class="keyword">WHERE</span> tag.tag<span class="operator">=</span><span class="string">&#x27;mysql&#x27;</span>;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tag <span class="keyword">WHERE</span> tag<span class="operator">=</span><span class="string">&#x27;mysql&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tag_post <span class="keyword">WHERE</span> tag_id<span class="operator">=</span><span class="number">1234</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> post <span class="keyword">WHERE</span> post.id <span class="keyword">IN</span> (<span class="number">123</span>,<span class="number">456</span>,<span class="number">567</span>,<span class="number">9098</span>,<span class="number">8904</span>);</span><br></pre></td></tr></table></figure><hr><h2 id="å­˜å‚¨å¼•æ“"><a href="#å­˜å‚¨å¼•æ“" class="headerlink" title="å­˜å‚¨å¼•æ“"></a>å­˜å‚¨å¼•æ“</h2><hr><h3 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h3><hr><p>æ˜¯MySQLé»˜è®¤çš„äº‹åŠ¡å‹å­˜å‚¨å¼•æ“ï¼Œåªæœ‰åœ¨éœ€è¦å®ƒä¸æ”¯æŒçš„ç‰¹æ€§æ—¶ï¼Œæ‰è€ƒè™‘å…¶ä»–çš„å­˜å‚¨å¼•æ“ã€‚</p><p>å®ç°äº†å››ä¸ªæ ‡å‡†çš„éš”ç¦»çº§åˆ«ï¼Œé»˜è®¤çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼ˆREPEATABLE READï¼‰ã€‚åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œé€šè¿‡å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ + Next-Key Lockingé˜²æ­¢å¹»è¯»ã€‚</p><p>ä¸»ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œåœ¨ç´¢å¼•ä¸­ä¿å­˜äº†æ•°æ®ï¼Œä»è€Œé¿å…ç›´æ¥è¯»å–ç£ç›˜ï¼Œå› æ­¤å¯¹æŸ¥è¯¢æ€§èƒ½æœ‰å¾ˆå¤§çš„æå‡ã€‚</p><p>å†…éƒ¨åšäº†å¾ˆå¤šä¼˜åŒ–ï¼ŒåŒ…æ‹¬ä»ç£ç›˜è¯»å–æ•°æ®æ—¶é‡‡ç”¨çš„å¯é¢„æµ‹æ€§è¯»ã€èƒ½å¤ŸåŠ å¿«è¯»å–æ“ä½œå¹¶ä¸”è‡ªåŠ¨åˆ›å»ºçš„è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ã€èƒ½å¤ŸåŠ é€Ÿæ’å…¥æ“ä½œçš„æ’å…¥ç¼“å­˜åŒºç­‰ã€‚</p><p>æ”¯æŒçœŸæ­£çš„åœ¨çº¿çƒ­å¤‡ä»½ ã€‚å…¶ä»–å­˜å‚¨å¼•æ“ä¸æ”¯æŒåœ¨çº¿çƒ­å¤‡ä»½ï¼Œè¦è·å–ä¸€è‡´æ€§è¯•å›¾éœ€è¦åœæ­¢å¯¹æ‰€æœ‰è¡¨çš„å†™å…¥ï¼Œè€Œåœ¨è¯»å†™æ··åˆåœºæ™¯ä¸­ï¼Œåœæ­¢å†™å…¥å¯èƒ½ä¹Ÿæ„å‘³ç€åœæ­¢è¯»å–ã€‚</p><hr><h3 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h3><hr><p>è®¾è®¡ç®€å•ï¼Œæ•°æ®ä»¥ç´§å¯†æ ¼å¼å­˜å‚¨ã€‚å¯¹äºåªè¯»æ•°æ®ï¼Œæˆ–è€…è¡¨æ¯”è¾ƒå°ã€å¯ä»¥å®¹å¿ä¿®å¤æ“ä½œï¼Œåˆ™ä¾ç„¶å¯ä»¥ä½¿ç”¨å®ƒã€‚</p><p>æä¾›äº†å¤§é‡çš„ç‰¹æ€§ï¼ŒåŒ…æ‹¬å‹ç¼©è¡¨ã€ç©ºé—´æ•°æ®ç´¢å¼•ç­‰ã€‚</p><p>ä¸æ”¯æŒäº‹åŠ¡ã€‚</p><p>ä¸æ”¯æŒè¡Œçº§é”ï¼Œåªèƒ½å¯¹æ•´å¼ è¡¨åŠ é”ï¼Œè¯»å–æ—¶ä¼šå¯¹éœ€è¦ç‹¬åˆ°çš„æ‰€æœ‰è¡¨å«å…±äº«é”ï¼Œå†™å…¥æ—¶åˆ™å¯¹è¡¨åŠ æ’å®ƒé”ã€‚ä½†åœ¨è¡¨æœ‰è¯»å–æ“ä½œçš„åŒæ—¶ï¼Œä¹Ÿå¯ä»¥å¾€è¡¨ä¸­æ’å…¥æ–°çš„è®°å½•ï¼Œè¿™è¢«ç§°ä¸ºå¹¶å‘æ’å…¥ï¼ˆCONCURRENT INSERTï¼‰ã€‚</p><p>å¯ä»¥æ‰‹å·¥æˆ–è€…è‡ªåŠ¨æ‰§è¡Œæ£€æŸ¥å’Œä¿®å¤æ“ä½œï¼Œä½†æ˜¯å’Œäº‹åŠ¡æ¢å¤ä»¥åŠå¥”æºƒæ¢å¤ä¸åŒï¼Œå¯èƒ½å¯¼è‡´ä¸€äº›æ•°æ®ä¸¢å¤±ï¼Œè€Œä¸”ä¿®å¤æ“ä½œæ˜¯éå¸¸æ…¢çš„ã€‚</p><p>å¦‚æœæŒ‡å®šäº† DELAY_KEY_WRITE é€‰é¡¹ï¼Œåœ¨æ¯æ¬¡ä¿®æ”¹æ‰§è¡Œå®Œæˆæ—¶ï¼Œä¸ä¼šç«‹å³å°†ä¿®æ”¹çš„ç´¢å¼•æ•°æ®å†™å…¥ç£ç›˜ï¼Œè€Œæ˜¯ä¼šå†™åˆ°å†…å­˜ä¸­çš„é”®ç¼“å†²åŒºï¼Œåªæœ‰åœ¨æ¸…ç†é”®ç¼“å†²åŒºæˆ–è€…å…³é—­è¡¨çš„æ—¶å€™æ‰ä¼šå°†å¯¹åº”çš„ç´¢å¼•å—å†™å…¥ç£ç›˜ã€‚è¿™ç§æ–¹å¼å¯ä»¥æå¤§çš„æå‡å†™å…¥æ€§èƒ½ï¼Œä½†æ˜¯åœ¨æ•°æ®åº“æˆ–è€…ä¸»æœºå´©æºƒæ—¶ä¼šé€ æˆç´¢å¼•æŸåï¼Œéœ€è¦æ‰§è¡Œä¿®å¤æ“ä½œã€‚</p><hr><h3 id="æ¯”è¾ƒ"><a href="#æ¯”è¾ƒ" class="headerlink" title="æ¯”è¾ƒ"></a>æ¯”è¾ƒ</h3><hr><pre><code>â— äº‹åŠ¡ï¼šInnoDBæ˜¯äº‹åŠ¡å‹çš„ï¼Œå¯ä»¥ä½¿ç”¨ Commit å’Œ Rollback è¯­å¥ã€‚â— å¹¶å‘ï¼šMyISAMåªæ”¯æŒè¡¨çº§é”ï¼Œè€ŒInnoDBè¿˜æ”¯æŒè¡Œçº§é”ã€‚â— å¤–é”®ï¼šInnoDBæ”¯æŒå¤–é”®ã€‚â— å¤‡ä»½ï¼šInnoDBæ”¯æŒåœ¨çº¿çƒ­å¤‡ä»½ã€‚â— å´©æºƒæ¢å¤ï¼šMyISAMå´©æºƒåå‘ç”ŸæŸåçš„æ¦‚ç‡æ¯”InnoDBé«˜å¾ˆå¤šï¼Œè€Œä¸”æ¢å¤çš„é€Ÿåº¦ä¹Ÿæ›´æ…¢ã€‚â— å…¶ä»–ç‰¹æ€§ï¼šMyISAMæ”¯æŒå‹ç¼©è¡¨å’Œç©ºé—´æ•°æ®ç´¢å¼•ã€‚</code></pre><hr><h3 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h3><hr><h4 id="æ•´å‹"><a href="#æ•´å‹" class="headerlink" title="æ•´å‹"></a>æ•´å‹</h4><hr><p>TINYINT, SMALLINT, MEDIUMINT, INT, BIGINT åˆ†åˆ«ä½¿ç”¨ 8, 16, 24, 32, 64 ä½å­˜å‚¨ç©ºé—´ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¶Šå°çš„åˆ—è¶Šå¥½ã€‚</p><p>INT(11) ä¸­çš„æ•°å­—åªæ˜¯è§„å®šäº†äº¤äº’å·¥å…·æ˜¾ç¤ºå­—ç¬¦çš„ä¸ªæ•°ï¼Œå¯¹äºå­˜å‚¨å’Œè®¡ç®—æ¥è¯´æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚</p><hr><h4 id="æµ®ç‚¹æ•°"><a href="#æµ®ç‚¹æ•°" class="headerlink" title="æµ®ç‚¹æ•°"></a>æµ®ç‚¹æ•°</h4><hr><p>FLOAT å’Œ DOUBLE ä¸ºæµ®ç‚¹ç±»å‹ï¼ŒDECIMAL ä¸ºé«˜ç²¾åº¦å°æ•°ç±»å‹ã€‚CPU åŸç”Ÿæ”¯æŒæµ®ç‚¹è¿ç®—ï¼Œä½†æ˜¯ä¸æ”¯æŒ DECIMAl ç±»å‹çš„è®¡ç®—ï¼Œå› æ­¤ DECIMAL çš„è®¡ç®—æ¯”æµ®ç‚¹ç±»å‹éœ€è¦æ›´é«˜çš„ä»£ä»·ã€‚</p><p>FLOATã€DOUBLE å’Œ DECIMAL éƒ½å¯ä»¥æŒ‡å®šåˆ—å®½ï¼Œä¾‹å¦‚ DECIMAL(18, 9) è¡¨ç¤ºæ€»å…± 18 ä½ï¼Œå– 9 ä½å­˜å‚¨å°æ•°éƒ¨åˆ†ï¼Œå‰©ä¸‹ 9 ä½å­˜å‚¨æ•´æ•°éƒ¨åˆ†ã€‚</p><hr><h4 id="å­—ç¬¦ä¸²"><a href="#å­—ç¬¦ä¸²" class="headerlink" title="å­—ç¬¦ä¸²"></a>å­—ç¬¦ä¸²</h4><hr><p>ä¸»è¦æœ‰ CHAR å’Œ VARCHAR ä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯å®šé•¿çš„ï¼Œä¸€ç§æ˜¯å˜é•¿çš„ã€‚</p><p>VARCHAR è¿™ç§å˜é•¿ç±»å‹èƒ½å¤ŸèŠ‚çœç©ºé—´ï¼Œå› ä¸ºåªéœ€è¦å­˜å‚¨å¿…è¦çš„å†…å®¹ã€‚ä½†æ˜¯åœ¨æ‰§è¡Œ UPDATE æ—¶å¯èƒ½ä¼šä½¿è¡Œå˜å¾—æ¯”åŸæ¥é•¿ï¼Œå½“è¶…å‡ºä¸€ä¸ªé¡µæ‰€èƒ½å®¹çº³çš„å¤§å°æ—¶ï¼Œå°±è¦æ‰§è¡Œé¢å¤–çš„æ“ä½œã€‚MyISAM ä¼šå°†è¡Œæ‹†æˆä¸åŒçš„ç‰‡æ®µå­˜å‚¨ï¼Œè€Œ InnoDB åˆ™éœ€è¦åˆ†è£‚é¡µæ¥ä½¿è¡Œæ”¾è¿›é¡µå†…ã€‚</p><p>åœ¨è¿›è¡Œå­˜å‚¨å’Œæ£€ç´¢æ—¶ï¼Œä¼šä¿ç•™ VARCHAR æœ«å°¾çš„ç©ºæ ¼ï¼Œè€Œä¼šåˆ é™¤ CHAR æœ«å°¾çš„ç©ºæ ¼ã€‚</p><hr><h3 id="æ—¶é—´å’Œæ—¥æœŸ"><a href="#æ—¶é—´å’Œæ—¥æœŸ" class="headerlink" title="æ—¶é—´å’Œæ—¥æœŸ"></a>æ—¶é—´å’Œæ—¥æœŸ</h3><hr><p>MySQL æä¾›äº†ä¸¤ç§ç›¸ä¼¼çš„æ—¥æœŸæ—¶é—´ç±»å‹ï¼šDATETIME å’Œ TIMESTAMPã€‚</p><hr><h4 id="DATETIME"><a href="#DATETIME" class="headerlink" title="DATETIME"></a>DATETIME</h4><hr><p>èƒ½å¤Ÿä¿å­˜ä» 1000 å¹´åˆ° 9999 å¹´çš„æ—¥æœŸå’Œæ—¶é—´ï¼Œç²¾åº¦ä¸ºç§’ï¼Œä½¿ç”¨ 8 å­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚</p><p>å®ƒä¸æ—¶åŒºæ— å…³ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒMySQL ä»¥ä¸€ç§å¯æ’åºçš„ã€æ— æ­§ä¹‰çš„æ ¼å¼æ˜¾ç¤º DATETIME å€¼ï¼Œä¾‹å¦‚â€œ2008-01-16 22:37:08â€ï¼Œè¿™æ˜¯ ANSI æ ‡å‡†å®šä¹‰çš„æ—¥æœŸå’Œæ—¶é—´è¡¨ç¤ºæ–¹æ³•ã€‚</p><hr><h4 id="TIMESTAMP"><a href="#TIMESTAMP" class="headerlink" title="TIMESTAMP"></a>TIMESTAMP</h4><hr><p>å’Œ UNIX æ—¶é—´æˆ³ç›¸åŒï¼Œä¿å­˜ä» 1970 å¹´ 1 æœˆ 1 æ—¥åˆå¤œï¼ˆæ ¼æ—å¨æ²»æ—¶é—´ï¼‰ä»¥æ¥çš„ç§’æ•°ï¼Œä½¿ç”¨ 4 ä¸ªå­—èŠ‚ï¼Œåªèƒ½è¡¨ç¤ºä» 1970 å¹´åˆ° 2038 å¹´ã€‚</p><p>å®ƒå’Œæ—¶åŒºæœ‰å…³ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªæ—¶é—´æˆ³åœ¨ä¸åŒçš„æ—¶åŒºæ‰€ä»£è¡¨çš„å…·ä½“æ—¶é—´æ˜¯ä¸åŒçš„ã€‚</p><p>MySQL æä¾›äº† FROM_UNIXTIME() å‡½æ•°æŠŠ UNIX æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸï¼Œå¹¶æä¾›äº† UNIX_TIMESTAMP() å‡½æ•°æŠŠæ—¥æœŸè½¬æ¢ä¸º UNIX æ—¶é—´æˆ³ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ’å…¥æ—¶æ²¡æœ‰æŒ‡å®š TIMESTAMP åˆ—çš„å€¼ï¼Œä¼šå°†è¿™ä¸ªå€¼è®¾ç½®ä¸ºå½“å‰æ—¶é—´ã€‚<br>åº”è¯¥å°½é‡ä½¿ç”¨ TIMESTAMPï¼Œå› ä¸ºå®ƒæ¯” DATETIME ç©ºé—´æ•ˆç‡æ›´é«˜ã€‚</p><hr><h2 id="åˆ‡åˆ†"><a href="#åˆ‡åˆ†" class="headerlink" title="åˆ‡åˆ†"></a>åˆ‡åˆ†</h2><hr><h3 id="æ°´å¹³åˆ‡åˆ†"><a href="#æ°´å¹³åˆ‡åˆ†" class="headerlink" title="æ°´å¹³åˆ‡åˆ†"></a>æ°´å¹³åˆ‡åˆ†</h3><hr><p>æ°´å¹³åˆ‡åˆ†åˆç§°ä¸º Shardingï¼Œå®ƒæ˜¯å°†åŒä¸€ä¸ªè¡¨ä¸­çš„è®°å½•æ‹†åˆ†åˆ°å¤šä¸ªç»“æ„ç›¸åŒçš„è¡¨ä¸­ã€‚</p><p>å½“ä¸€ä¸ªè¡¨çš„æ•°æ®ä¸æ–­å¢å¤šæ—¶ï¼ŒSharding æ˜¯å¿…ç„¶çš„é€‰æ‹©ï¼Œå®ƒå¯ä»¥å°†æ•°æ®åˆ†å¸ƒåˆ°é›†ç¾¤çš„ä¸åŒèŠ‚ç‚¹ä¸Šï¼Œä»è€Œç¼“å­˜å•ä¸ªæ•°æ®åº“çš„å‹åŠ›ã€‚</p><hr><h3 id="å‚ç›´åˆ‡åˆ†"><a href="#å‚ç›´åˆ‡åˆ†" class="headerlink" title="å‚ç›´åˆ‡åˆ†"></a>å‚ç›´åˆ‡åˆ†</h3><hr><p>å‚ç›´åˆ‡åˆ†æ˜¯å°†ä¸€å¼ è¡¨æŒ‰åˆ—åˆ‡åˆ†æˆå¤šä¸ªè¡¨ï¼Œé€šå¸¸æ˜¯æŒ‰ç…§åˆ—çš„å…³ç³»å¯†é›†ç¨‹åº¦è¿›è¡Œåˆ‡åˆ†ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨å‚ç›´åˆ‡åˆ†å°†ç»å¸¸è¢«ä½¿ç”¨çš„åˆ—å’Œä¸ç»å¸¸è¢«ä½¿ç”¨çš„åˆ—åˆ‡åˆ†åˆ°ä¸åŒçš„è¡¨ä¸­ã€‚</p><p><img data-src="/../../images/mysql/msql3.png" alt="PNG" loading="lazy"></p><p>åœ¨æ•°æ®åº“çš„å±‚é¢ä½¿ç”¨å‚ç›´åˆ‡åˆ†å°†æŒ‰æ•°æ®åº“ä¸­è¡¨çš„å¯†é›†ç¨‹åº¦éƒ¨ç½²åˆ°ä¸åŒçš„åº“ä¸­ï¼Œä¾‹å¦‚å°†åŸæ¥çš„ç”µå•†æ•°æ®åº“å‚ç›´åˆ‡åˆ†æˆå•†å“æ•°æ®åº“ã€ç”¨æˆ·æ•°æ®åº“ç­‰ã€‚</p><p><img data-src="/../../images/mysql/mysql4.png" alt="PNG" loading="lazy"></p><hr><h3 id="Shardingç­–ç•¥"><a href="#Shardingç­–ç•¥" class="headerlink" title="Shardingç­–ç•¥"></a>Shardingç­–ç•¥</h3><hr><pre><code>â— å“ˆå¸Œå–æ¨¡ï¼šhash(key)%N;â— èŒƒå›´ï¼šå¯ä»¥æ˜¯IDèŒƒå›´ä¹Ÿå¯ä»¥æ˜¯æ—¶é—´èŒƒå›´â— æ˜ å°„è¡¨ï¼šä½¿ç”¨å•ç‹¬çš„ä¸€ä¸ªæ•°æ®åº“æ¥å­˜å‚¨æ˜ å°„å…³ç³»ã€‚</code></pre><hr><h3 id="Shardingå­˜åœ¨çš„é—®é¢˜"><a href="#Shardingå­˜åœ¨çš„é—®é¢˜" class="headerlink" title="Shardingå­˜åœ¨çš„é—®é¢˜"></a>Shardingå­˜åœ¨çš„é—®é¢˜</h3><hr><h4 id="äº‹åŠ¡é—®é¢˜"><a href="#äº‹åŠ¡é—®é¢˜" class="headerlink" title="äº‹åŠ¡é—®é¢˜"></a>äº‹åŠ¡é—®é¢˜</h4><hr><p>ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ¥è§£å†³ï¼Œæ¯”å¦‚ XA æ¥å£ã€‚</p><hr><h4 id="è¿æ¥"><a href="#è¿æ¥" class="headerlink" title="è¿æ¥"></a>è¿æ¥</h4><hr><p>å¯ä»¥å°†åŸæ¥çš„è¿æ¥åˆ†è§£æˆå¤šä¸ªå•è¡¨æŸ¥è¯¢ï¼Œç„¶ååœ¨ç”¨æˆ·ç¨‹åºä¸­è¿›è¡Œè¿æ¥ã€‚</p><hr><h4 id="IDå”¯ä¸€æ€§"><a href="#IDå”¯ä¸€æ€§" class="headerlink" title="IDå”¯ä¸€æ€§"></a>IDå”¯ä¸€æ€§</h4><hr><pre><code>â— ä½¿ç”¨å…¨å±€å”¯ä¸€ ID (GUID)â— ä¸ºæ¯ä¸ªåˆ†ç‰‡æŒ‡å®šä¸€ä¸ªIDèŒƒå›´â— åˆ†å¸ƒå¼IDç”Ÿæˆå™¨(å¦‚ Twitter çš„ Snowflake ç®—æ³•)</code></pre><hr><h2 id="å¤åˆ¶"><a href="#å¤åˆ¶" class="headerlink" title="å¤åˆ¶"></a>å¤åˆ¶</h2><hr><h3 id="ä¸»ä»å¤åˆ¶"><a href="#ä¸»ä»å¤åˆ¶" class="headerlink" title="ä¸»ä»å¤åˆ¶"></a>ä¸»ä»å¤åˆ¶</h3><hr><p>ä¸»è¦æ¶‰åŠä¸‰ä¸ªçº¿ç¨‹ï¼šbinlogçº¿ç¨‹ã€I&#x2F;Oçº¿ç¨‹å’Œ SQLçº¿ç¨‹ã€‚</p><pre><code>â— binlogçº¿ç¨‹ï¼šè´Ÿè´£å°†ä¸»æœåŠ¡å™¨ä¸Šçš„æ•°æ®æ›´æ”¹å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinarylogï¼‰ä¸­ã€‚â— I/Oçº¿ç¨‹ï¼šè´Ÿè´£ä»ä¸»æœåŠ¡å™¨ä¸Šè¯»å–äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå¹¶å†™å…¥æœåŠ¡å™¨çš„ä¸­ç»§æ—¥å¿—ï¼ˆRelay logï¼‰ã€‚â— SQLçº¿ç¨‹ï¼šè´Ÿè´£è¯»å–ä¸­ç»§æ—¥å¿—ï¼Œè§£æå‡ºä¸»æœåŠ¡å™¨å·²ç»æ‰§è¡Œçš„æ•°æ®æ›´æ”¹å¹¶åœ¨ä»æœåŠ¡å™¨ä¸­é‡æ”¾ï¼ˆReplayï¼‰ã€‚</code></pre><p><img data-src="/../../images/mysql/mysql5.png" alt="PNG" loading="lazy"></p><hr><h3 id="è¯»å†™åˆ†ç¦»"><a href="#è¯»å†™åˆ†ç¦»" class="headerlink" title="è¯»å†™åˆ†ç¦»"></a>è¯»å†™åˆ†ç¦»</h3><hr><p>ä¸»æœåŠ¡å™¨å¤„ç†å†™æ“ä½œä»¥åŠå®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„è¯»æ“ä½œï¼Œè€Œä»æœåŠ¡å™¨å¤„ç†è¯»æ“ä½œã€‚</p><p>è¯»å†™åˆ†ç¦»èƒ½æé«˜æ€§èƒ½çš„åŸå› åœ¨äºï¼š</p><pre><code>â— ä¸»ä»æœåŠ¡å™¨è´Ÿè´£å„è‡ªçš„è¯»å’Œå†™ï¼Œæå¤§ç¨‹åº¦ç¼“è§£äº†é”çš„äº‰ç”¨ï¼›â— ä»æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨ MyISAMï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ä»¥åŠèŠ‚çº¦ç³»ç»Ÿå¼€é”€ï¼›â— å¢åŠ å†—ä½™ï¼Œæé«˜å¯ç”¨æ€§ã€‚</code></pre><p>è¯»å†™åˆ†ç¦»å¸¸ç”¨ä»£ç†æ–¹å¼æ¥å®ç°ï¼Œä»£ç†æœåŠ¡å™¨æ¥æ”¶åº”ç”¨å±‚ä¼ æ¥çš„è¯»å†™è¯·æ±‚ï¼Œç„¶åå†³å®šè½¬å‘åˆ°å“ªä¸ªæœåŠ¡å™¨ã€‚</p><p><img data-src="/../../images/mysql/mysql6.png" alt="PNG" loading="lazy"></p><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;!-- START doctoc generated TOC please keep comment here to allow auto update --&gt;
&lt;!-- DON&#39;T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPD</summary>
      
    
    
    
    <category term="æ•°æ®åº“" scheme="https://blog.zcchub.xyz/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="mysql S" scheme="https://blog.zcchub.xyz/tags/mysql-S/"/>
    
    <category term="æ•°æ®åº“" scheme="https://blog.zcchub.xyz/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
</feed>
